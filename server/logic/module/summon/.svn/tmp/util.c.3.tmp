#include <debug.h>
#include <frames.h>
#include <summon_key.h>
#include <item_key.h>
#include <user_key.h>
//#include <summon_attribute.h>
#include <summon.h>
#include <macros.h>
#include "/rc/rpc/summon.h"
#include "/module/fight/fight.h"

static object logger;
static mapping mpSummonProp;  

void rpcSummonInfo(int uid, int summonId);
class Summon summonInfoPack(int summonId);
int getSummonFightValue(int summonId, mixed key);
int addNewSummonByType(object user, int type);
int createSummon(int type);
int restoreSummon(mapping mpSave);
int calculateSummon(int summonId);
varargs int addNewSummonById(object user, int summonId, int bagId);

int restoreSummon(mapping mpSave)
{
	int type = mpSave[K_SUMMON_TYPE];
	int summonId;


	summonId = restore_summon(SUMMON_PATH, mpSave);

	if ( summonId < 0) 
	{
		//debug_message( sprintf("ERROR:Restore Summon失败！%O", mpSave) );
		return summonId;
	}
	
	SetSummonTemp( summonId, KT_SUMMON_RESOURCE, type);
	calculateSummon(summonId);

	return summonId;
}
/*
*return 0失败 大于0成功 值为summonId
*/
int addNewSummonByType(object user, int type)
{
	if (user->hasSummonByType(type))
	{
		//debug_message("添加灵兽error已有类型");
		return 0;	
	}
	int summonId = createSummon(type);
	if (!summonId)
	{
		//debug_message("添加灵兽error创建灵兽");
		return 0;
	}

	int pos = addNewSummonById(user, summonId);
	if (!pos)
	{
		//debug_message("添加灵兽error添加到包裹");
		destroy_summon(summonId);
		return 0;
	}
	user->addSummonType(type);
	//rpcSummonInfo(user->getId(), summonId);
	return summonId;
}

int destroySummon(int summonId)
{
	int equipBagId = GetSummonSave(summonId, K_SUMMON_EQUIP_BAGID);
	int bagId = GetSummonTemp(summonId, KT_SUMMON_BAG);
	int owner = GetSummonTemp(summonId, KT_SUMMON_OWNER);
	object user = get_user(owner);

	if (!objectp(user)) {
		destroy_summon(summonId);
		return 1;
	}

	if (equipBagId) {
		int items = user->getAllItemsInBag(equipBagId);
		foreach (int item in items) {
			if (!user->MoveItem(item, ITEM_BAG_NORMAL)) {
				// 物品栏满，无法删除召唤兽
				return 0;
			}
		}
	}

	if (user->removeSummonFromBag(summonId, bagId)) {
		destroy_summon(summonId);
		return 1;
	}
	return 0;
}

int getSummonFightValue( int summonId, mixed key) 
{
	mapping mpData = get_summon_map(summonId, TEMP_VAR);
	if ( undefinedp(mpData)) return 0;
	mapping tmpFightValue = get_summon_map(summonId, TEMP_VAR)[K_FIGHT_TOTAL];
	return tmpFightValue[key];
}
	
mapping calculateSummonBase(int grade, int type)
{
	mapping mpTempBase = ([]);
	mpTempBase[KT_SUMMON_NAILI] =  to_int(pow(grade,1.2)/5*10) + mpSummonProp[type][KT_SUMMON_INI_NAILI]; 
	mpTempBase[KT_SUMMON_LILIANG] =  to_int(pow(grade,1.2)/5*10) + mpSummonProp[type][KT_SUMMON_INI_LILIANG];
	mpTempBase[KT_SUMMON_ZHILI] =  to_int(pow(grade,1.2)/5*10) + mpSummonProp[type][KT_SUMMON_INI_ZHILI];
	mpTempBase[KT_SUMMON_MINJIE] =  to_int(pow(grade,1.2)/5*10) + mpSummonProp[type][KT_SUMMON_INI_MINJIE];
	return mpTempBase;
}

int calculateSummon(int summonId)
{
	mapping mpPermVar, mpTempBase, mpTempTotal;
	int summonType = GetSummonSave(summonId, K_SUMMON_TYPE);
	
	mpPermVar = get_summon_map(summonId, PERM_VAR);
	mapping mpTempVar = get_summon_map(summonId, TEMP_VAR);

	int grade = mpPermVar[K_SUMMON_GRADE];
	int owner = mpTempVar[KT_SUMMON_OWNER];
	mpTempBase = calculateSummonBase(grade, summonType);
	mpTempTotal = ([]);
	
	//todo 下面获得经验要改
	//经验未导表，暂时写死	
	SetSummonTemp(summonId, KT_SUMMON_EXP_NEXT, 500 * grade ); 
	mpTempVar[K_FIGHT_BASE] = mpTempBase;
	mpTempVar[K_FIGHT_TOTAL] = mpTempTotal;

	int equipBagId = mpPermVar[K_SUMMON_EQUIP_BAGID];

	mapping equipBagAttr = ([]);

	object user = get_user(owner);

	if (owner && objectp(user)) {
		equipBagAttr = "module/equip/main"->getBagEquipAttr(user, equipBagId);

		if (sizeof(equipBagAttr)) {
			mpTempBase[KT_SUMMON_NAILI] += equipBagAttr[NAILI];
			mpTempBase[KT_SUMMON_LILIANG] += equipBagAttr[LILIANG];
			mpTempBase[KT_SUMMON_ZHILI] += equipBagAttr[ZHILI];
			mpTempBase[KT_SUMMON_MINJIE] += equipBagAttr[MINJIE];
		}
	}

	mpTempTotal[KT_SUMMON_MAXHP] = equipBagAttr[FT_HP] + to_int(mpTempBase[KT_SUMMON_NAILI] * 5);
	mpTempTotal[KT_SUMMON_DEFENCE] = equipBagAttr[FT_DEFENCE] + to_int(mpTempBase[KT_SUMMON_LILIANG] * 0.5);
	mpTempTotal[KT_SUMMON_ATTACK] = equipBagAttr[FT_ATTACK] + to_int(mpTempBase[KT_SUMMON_LILIANG] * 1.5);
	mpTempTotal[KT_SUMMON_QIANGFA] = equipBagAttr[FT_QIANGFA] + to_int(mpTempBase[KT_SUMMON_ZHILI] * 1.5);
	mpTempTotal[KT_SUMMON_KANGFA] = equipBagAttr[FT_KANGFA] + to_int(mpTempBase[KT_SUMMON_ZHILI] * 0.5);
	mpTempTotal[KT_SUMMON_SPEED] = equipBagAttr[FT_SPEED] + to_int(mpTempBase[KT_SUMMON_MINJIE] * 1);

	mpPermVar[K_SUMMON_CUR_HP] = (mpTempTotal[KT_SUMMON_MAXHP]);
	return 1;
}

int findSummonIdByEquipBagId(object user, int equipBagId)
{
	int *summons = user->getAllSummonsInBag();

	foreach (int summId in summons) {
		if (GetSummonSave(summId, K_SUMMON_EQUIP_BAGID) == equipBagId) {
			return summId;
		}
	}
	return 0;
}

string getNameByType(int type)
{
	return mpSummonProp[type][K_SUMMON_NAME];
}

/*
*return 0失败 大于0成功,值为summonId
*/
int createSummon(int type)
{
	int summonId;
	if (undefinedp(mpSummonProp[type]))
	{
		//debug_message(sprintf("灵兽类型[%d]不存在!", type));
		return 0;	
	}
	summonId = new_summon(SUMMON_PATH);
	if (!summonId) 
	{
		//debug_message("无法生成灵兽!");
		return 0;
	}

	SetSummonSave(summonId, K_SUMMON_TYPE, type);
	SetSummonSave(summonId, K_SUMMON_NAME, getNameByType(type) );
	SetSummonSave(summonId, K_SUMMON_GRADE, 1);     /*等级*/
	SetSummonSave(summonId, K_SUMMON_EXP, 0);     /*等级*/
	//SetSummonSave(summonId, M_SUMM_SKILL_GRID, ([]));
	calculateSummon(summonId);
	SetSummonSave( summonId, K_SUMMON_CUR_HP, getSummonFightValue( summonId, KT_SUMMON_MAXHP) );
	SetSummonTemp( summonId, KT_SUMMON_RESOURCE, mpSummonProp[type][K_SUMMON_TYPE]);
	return summonId;
}

/*
*这个函数将新生的灵兽加到包裹里
*return 0失败 大于0为添加到的bag pos
*/
varargs int addNewSummonById(object user, int summonId, int bagId)
{
	if (summonId <= 0)
		return 0;
	SetSummonTemp(summonId, KT_SUMMON_OWNER, user->getId());
	if (undefinedp(bagId))
		bagId = SUMMON_BAG_NORMAL;
	int ret = user->addSummonToBag(summonId, bagId);
	int uid = user->getId();
	if (!ret) 
	{
		debug_message(sprintf("玩家[%d]添加灵兽[%O]失败!", uid, get_summon_map(summonId, 1)));
		destroy_summon(summonId);
		return 0;
	}
	
	if ( GetSummonSave(summonId, K_GLOBAL_KEY) == "" )
	{
		string globalKey = Import("GLOBAL_KEY")->new_summon_globalkey();	
		SetSummonSave(summonId, K_GLOBAL_KEY, globalKey);
		logger->Log("[%d]AddSummon,summonId=%d, type=%d, global_key=%s.", uid,summonId, GetSummonSave(summonId, K_SUMMON_TYPE), GetSummonSave(summonId, K_GLOBAL_KEY) );
		// 新增的灵兽GBLKEY添加到玩家身上
		mapping mpGlobalKeys = user->getTemp(KT_SUMMON_GLOBALKEY_MAP);
		if(undefinedp(mpGlobalKeys[globalKey])) {
			mpGlobalKeys[globalKey] = summonId;
		}
	}

	int equipBagId = user->createSummonEquipFrames(GetSummonSave(summonId, K_GLOBAL_KEY));

	if (!equipBagId) {
		debug_message("[%d] 灵兽创建装备栏失败 %s", uid, GetSummonSave(summonId, K_GLOBAL_KEY));
		destroy_summon(summonId);
		return 0;
	}
	SetSummonSave(summonId, K_SUMMON_EQUIP_BAGID, equipBagId);
	return ret;
}

void rpcSummonInfo(int uid, int summonId)
{
	class Summon summonInfo = summonInfoPack(summonId);

	rpc_client_summon_info(uid, summonInfo);
}	

class Summon summonInfoPack(int summonId)
{
	class Summon summonInfo = new(class Summon);	
	int summonType = GetSummonSave(summonId, K_SUMMON_TYPE);
	mapping mpInfo = mpSummonProp[summonType];
	summonInfo->summonId = summonId;
	summonInfo->typeid = summonType;
	summonInfo->icon = mpInfo[KT_SUMMON_RESOURCE];
	summonInfo->bagId = GetSummonTemp(summonId, KT_SUMMON_BAG);
	summonInfo->pos =  GetSummonTemp(summonId, KT_SUMMON_POS);
	summonInfo->name = GetSummonSave(summonId, K_SUMMON_NAME);
	summonInfo->grade = GetSummonSave(summonId, K_SUMMON_GRADE);
	summonInfo->hp = GetSummonSave(summonId, K_SUMMON_CUR_HP);
	summonInfo->maxHP = getSummonFightValue(summonId, KT_SUMMON_MAXHP);
	summonInfo->attack = getSummonFightValue(summonId, KT_SUMMON_ATTACK);
	summonInfo->defence = getSummonFightValue(summonId, KT_SUMMON_DEFENCE);
	summonInfo->qiangfa = getSummonFightValue(summonId, KT_SUMMON_QIANGFA);
	summonInfo->kangfa = getSummonFightValue(summonId, KT_SUMMON_KANGFA);
	summonInfo->speed = getSummonFightValue(summonId, KT_SUMMON_SPEED);

	summonInfo->equipBagId = GetSummonSave(summonId, K_SUMMON_EQUIP_BAGID);
	return summonInfo;	
}


void create()
{
	logger = Import("LOG")->New("summon_util");
	mpSummonProp = "module/summon/summon_base_data"->get_data();
}

int getSummonResource(int summonId)
{
	return GetSummonTemp(summonId, KT_SUMMON_RESOURCE);
}

string getSummonName(int summonId)
{
	return GetSummonSave(summonId, K_SUMMON_NAME);
}

int getSummonGrade(int summonId)
{
	return GetSummonSave(summonId, K_SUMMON_GRADE);
}

int getSummonType(int summonId)
{
	return GetSummonSave(summonId, K_SUMMON_TYPE);
}

