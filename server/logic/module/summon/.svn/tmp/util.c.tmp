#if 0
//
// ================================================
// 灵兽操作模块
// 说明： 
//     1. 灵兽根据等级, 初值, 资质计算属性, 不须加点!
//     2. 
//

#if 0
#include <debug.h>
#include <frames.h>
#include <summon_key.h>
#include <item_key.h>
#include <user_key.h>
#include <summon_attribute.h>
#include <var_prop.h>
#include <macros.h>
#include "/rc/rpc/summon.h"
#include <fight.h>
#include <summon.h>
#include <macros.h>
#include "/module/achieve/achieve_def.h"
#include "/module/achieve/achieve_arg_def.h"
#include "/module/newbie/newbie_achieve_def.h"

static mapping mpAttribInfo = ([]);

static mapping mpSummonProp = 
#include "prop.inl"
;

// 自动生成的稀有度对应表
// 编号要和境界挂钩
// 基本造型: ([ PUTONG: xx, XIYOU: xx, ... ]);
static mapping mpBaseRarity = ([ ]);
//	mpRace2Rarity[_race][_typical][realm][_rarity] = _type;
static mapping mpRace2Rarity = ([ ]);
// 所有type对应的境界表
static mapping mpAllRealms = ([]);


int GetSummonFightValue( int summonId, mixed key );
int CalSummon(int summid);
int FightingPoint(int summid);
void rpc_SummonElement( int uid, int summonid);
int GetRarity(int iType);
int GetSummonColor(int summonid);
varargs string ShoulongTypeByGrow(int iRealm, int iGrow, int iRace, int iType);
void rpc_SummonWuxing(int uid, int summid);
mixed *GetSummonSkillLib(int summid);

private object logger;
static string summon_log_key = "summon";
static string summon_grade_key = "summon_grade";
static string add_summon_key = "add_summon";
static string summon_niepan_key = "summon_niepan";
static string summon_chongsheng_key = "summon_chongsheng";


void create_logger()
{
	logger = Import("LOG")->New("summon");

	// globalkey, iGrade
	logger->SetDBFormat(summon_grade_key, "%s,%d");
	// uid, globalkey, type
	logger->SetDBFormat(add_summon_key, "%d,%s,%d");
	// globalkey, baktype, type, grow
	logger->SetDBFormat(summon_niepan_key, "%s,%d,%d,%d");
	// globalkey, baktype, type
	logger->SetDBFormat(summon_chongsheng_key, "%s,%d,%d");
}	

int ExpNext(int iGrade)
{
	return Import("UTIL")->CalNextExpSummon(iGrade); 
}

int FangChenmi(int exp)
{
	//return Import("WALLOW")->FixReward(exp);
	return exp;
}

void OnSummonUpgradeAch(object oUser, int iGrade)
{
	mapping arg = ([]);
	arg[AK_SUMMON_GRADE] = iGrade;
	oUser->StatsGroupExec(ACH_SUMMON_GRADE, 1, arg);
}

/*
// 新手目标统计 精良灵兽、珍稀灵兽
void SummonGrowNewbieAch(object oUser, int iSummid)
{
	int iGrow = GetSummonSave(iSummid, I_SUMM_GROW);
	if(iGrow == SUMMON_GROW_LAN) {
		oUser->NewbieStatsExec(SYS_MACROS_JING_LIANG_LING_SHOU, 1);
	}
	else if(iGrow == SUMMON_GROW_ZI) {
		oUser->NewbieStatsExec(SYS_MACROS_ZHEN_XI_LING_SHOU, 1);
	}
}

// 新手目标统计 灵兽技能数量
void SummonSkillCntNewbieAch(object oUser, int iSummid)
{
	string * cSkillLibs = GetSummonSkillLib(iSummid);
	oUser->NewbieStatsExec(SYS_MACROS_LING_SHOU_JI_NENG_SHUO_LIANG, sizeof(cSkillLibs));
}

// 新手目标统计 灵兽激活六个四级技能
void SummonSkillLvAch(object oUser, int iSummid)
{
	mapping * mpSkills = GetSummonSave(iSummid, M_SUMM_SKILLS);
	if(sizeof(mpSkills) >= 6) {
		int iNum = 0;
		foreach(string cSkill, int iLv in mpSkills) {
			if(iLv >= 4) {
				++ iNum;
			}
		}

		if(iNum >= 6) {
			oUser->NewbieStatsExec(SYS_MACROS_LING_SHOU_JI_HUO_LU_GE_SI_JI_JI_NENG, 1);
		}
	}
}

// 新手目标统计 灵兽亲密
void SummonQinmiNewbieAch(object oUser, int iQinmi)
{
	oUser->NewbieStatsExec(SYS_MACROS_LING_SHOU_QING_MI, iQinmi);
}

// 新手目标统计 参战灵兽激活技能数量
void FightSummonSkillNumAch(object oUser, int iSummid)
{
	mapping * mpSkills = GetSummonSave(iSummid, M_SUMM_SKILLS);
	oUser->NewbieStatsExec(SYS_MACROS_SHEN_ZHAN_LING_SHOU_JI_HUO_JI_NENG_SHUO_LIANG, sizeof(mpSkills));
}
*/

// 新手目标统计 灵兽出战
void SetFightSummonAch(object oUser)
{
	oUser->NewbieStatsExec(SYS_MACROS_LING_SHOU_CHU_ZHAN, 1);
}

// 新手目标统计 拥有一只蓝品质灵兽，并且缘生境界和旋照境界的技能满
void BlueSummonYuanshengXuanzhaoSkillAch(object oUser, int summid)
{
	Import("NEWBIE_ACHIEVE")->CheckBlueSpecialSumm(oUser, SYS_MACROS_YUAN_SHENG_XUAN_ZHAO_LAN_SHAI_LING_SHOU, summid);
}

void rpc_SummonInfo(int uid, int summid);

// 灵兽升级(现有技能有几率升级(不能超过境界限制))
int AddExp(int summid, int exp)
{
	int iGrade, iOwner, iNowExp, iExpNext, iRealm ;
	object oUser;
	int upgrade = 0;

	iOwner = GetSummonTemp(summid, I_T_SUMM_OWNER);
	oUser = get_user(iOwner);
	assert( iOwner );
	assert( objectp(oUser) );

	iGrade = GetSummonSave(summid, I_SUMM_GRADE);


	// 防沉迷的结算
	exp = FangChenmi(exp);
	exp = to_int(exp);
	iNowExp = GetSummonSave( summid, I_SUMM_EXP) + exp ;
	iExpNext = ExpNext(iGrade);
	if ( iGrade >= oUser->GetGrade() && iNowExp >= iExpNext )
	{
		oUser->TellMe("您需要更高的级别，才能使灵兽继续获得经验");
		exp = iExpNext - GetSummonSave(summid, I_SUMM_EXP);
		iNowExp = iExpNext;
	}

	iRealm = GetSummonTemp(summid, I_T_SUMM_REALM); 
	while ( iNowExp > iExpNext )
	{
		// 升级函数，以后有需要再提出来
		iGrade += 1;
		SetSummonSave(summid, I_SUMM_GRADE, iGrade);
		OnSummonUpgradeAch(oUser, iGrade);
		// 获取技能
		Import("SUMMON_SKILL")->OnUpgrade(summid);
		CalSummon(summid);
		rpc_SummonWuxing(iOwner, summid);

		// rsync to client
		// rpc_client_summon_grade(iOwner, summid, iGrade);
		if ( iRealm != GetSummonTemp(summid, I_T_SUMM_REALM) )
		{
			Import("SUMMON_SKILL")->OnUpRealm(oUser, summid);
			iRealm = GetSummonTemp(summid, I_T_SUMM_REALM);
		}

		// I_SUMM_CUR_HP
		SetSummonSave( summid, I_SUMM_CUR_HP, GetSummonFightValue( summid, I_A_HP_MAX_KEY) );	
		// I_SUMM_CUR_MP
		SetSummonSave( summid, I_SUMM_CUR_MP, GetSummonFightValue( summid, I_A_MP_MAX_KEY) );	

		rpc_SummonInfo(iOwner, summid);
		rpc_SummonElement(iOwner, summid);

		iNowExp -= iExpNext;
		iExpNext = ExpNext(iGrade);
		logger->Log("%d's summon %s upgrade to %d.", iOwner, GetSummonSave(summid, C_GLOBAL_KEY), iGrade);
		logger->DB( summon_grade_key, GetSummonSave(summid, C_GLOBAL_KEY), iGrade);
		oUser->TellTips(sprintf("你的灵兽[%s]升到%d级", GetSummonSave( summid, C_SUMM_NAME), iGrade));
		upgrade = 1;
	}

	SetSummonSave(summid, I_SUMM_EXP, to_int(iNowExp));
	rpc_client_summon_exp(iOwner, summid, iNowExp);

	if (upgrade) {
		Import("COMMON_HOOK")->SummonUpGrade(oUser, summid);
	}

	return exp;
}

int CanAddExp(int summid, int iExp)
{
	return 1;
}

int SummonQinmiLevel(int iGrade)
{
	return (iGrade-1)/10+1;
}	

int AddQinmi(object oUser, int summid, int iAdd)
{
	int iLevel = SummonQinmiLevel( GetSummonSave(summid, I_SUMM_GRADE) );
	int iBak = GetSummonSave(summid, I_SUMM_QINMI);
	int iQinmi = iBak+iAdd;
	int iMax = "data/summon_qinmi"->get_data()[iLevel]["max_limit"];

	if ( iQinmi >= iMax ) 
	{ 
		iQinmi = iMax; 
		oUser->TellMe("灵兽亲密达到上限，请提升灵兽等级。");

		// 亲密成就
		mapping arg = ([]);
		arg[AK_SUMMON_QINMI] = iMax;
		oUser->StatsGroupExec( ACH_SUMMON_QINMI, 1, arg);
	}
	SetSummonSave(summid, I_SUMM_QINMI, iQinmi);
	//rpc_client_summon_iprop( oUser->GetId(), summid, "iQinmi", iQinmi);

	CalSummon(summid);
	rpc_SummonInfo(oUser->GetId(), summid);

	return iQinmi-iBak;
}

string GetNameByType(mixed type)
{
	return mpSummonProp[type][C_SUMM_NAME];
}

int GetLifeByType(mixed type)
{
	return mpSummonProp[type][LIFETIME];
}

int GetLifeFactor(mixed type)
{
	return mpSummonProp[type][LIFETIME_FACTOR];
}

int GetRealmByType(mixed type)
{
	return mpSummonProp[type][I_T_SUMM_REALM];
}	

int GetRaceByType(mixed type)
{
	return mpSummonProp[type][SUMMON_RACE];
}

int GetiSummonValue( int summid, mixed key )
{
	mapping mpPermVar;

	mpPermVar = get_summon_map(summid, PERM_VAR);

	return to_int(mpPermVar[key]);
}

int SetiSummonValue( int summid, mixed key, int value )
{
	mapping mpPermVar;

	mpPermVar = get_summon_map(summid, PERM_VAR);

	mpPermVar[key] = value;
}

// 亲密和悟性 的初始统计
void CalQinmiWuxing(int summid)
{
	int iGrade = GetSummonSave(summid, I_SUMM_GRADE);
	mapping mpInfo = GetSummonSave(summid, M_SUMM_QINMI_INFO);

	if (!mapp(mpInfo) ) 
	{	
		mpInfo = ([]);
		SetSummonSave(summid, M_SUMM_QINMI_INFO, mpInfo);
	}	

	mpInfo["total"] = iGrade + mpInfo["addon"]; // 龙玉增加的值

	if ( !mpInfo["points"] ) 
		mpInfo["points"] = ([ "hp" :0, "mp":0, "att" : 0, "qiangfa" :0, "kangfa":0, "def" :0, "spe" :0, ]);
}

static int calculatingSumm = 0;

// 计算灵兽属性(初值，资质(成长率), 技能等)
int CalSummon(int summid)
{
	int iType, iGrade;
	int i, iChuzhi, iZizhi, iJingjie, iJingjieLv, iValue;
	mapping mpPermVar;
	mapping mpTempVar, mpTempBase, mpTempEquip, mpTempAchive, mpTempStatus, mpTempSkill, mpTempQinmi, mpTempTotal;

	iType = GetSummonSave(summid, I_SUMM_TYPE);
	if (undefinedp(mpSummonProp[iType])) 
	{
		debug_message(sprintf("不存在的Type: %d, summid %d.", iType, summid));
		return 0;
	}

	// 防止CalSummon递归调用自己，产生技能，图饰效果叠加计算
	if ( calculatingSumm == summid )
	{
		return 0;
	}

	calculatingSumm = summid;

	mpPermVar = get_summon_map(summid, PERM_VAR);
	mpTempVar = get_summon_map(summid, TEMP_VAR);

	iGrade = mpPermVar[I_SUMM_GRADE];

	SetSummonTemp(summid, I_T_SUMM_EXP_NEXT, ExpNext(iGrade) ); 

	// 设置境界
	for (i = sizeof(mpRealmInfo); i > 0; i--) 
	{
		if (iGrade < mpRealmInfo[i]["mingrade"]) continue; 

		iJingjie = i;
		break;
	}
	SetSummonTemp( summid, I_T_SUMM_REALM, iJingjie);
	SetSummonTemp(summid, I_T_GROW_COLOR, GetSummonColor(summid));

	if ( !GetSummonSave(summid, I_SUMM_RES) )
		SetSummonSave(summid, I_SUMM_RES, mpSummonProp[iType][I_SUMM_RES]);     /*资源ID*/

	CalQinmiWuxing(summid);

	// 基础数值
	mpTempBase = ([]);
	// 装备数值
	mpTempEquip = ([]);
	// 成就数值
	mpTempAchive = ([]);
	// 状态数值
	mpTempStatus = ([]);
	// 技能
	mpTempSkill = ([]);
	// 亲密修改的属性
	mpTempQinmi = ([]);
	// 数值总合
	mpTempTotal = ([]);

	// 增加等级和境界
	mpTempTotal[I_FWVK_GRADE] = iGrade;
	mpTempTotal[I_A_JINGJIE_KEY] = iJingjie;

	mpTempVar[A_K_BASE] = mpTempBase;
	mpTempVar[A_K_EQUIP] = mpTempEquip;
	mpTempVar[A_K_ACHIEVE] = mpTempAchive;
	mpTempVar[A_K_STATUS] = mpTempStatus;
	mpTempVar[A_K_SKILL] = mpTempSkill;
	mpTempVar[A_K_QINMI] = mpTempQinmi;
	mpTempVar[A_K_TOTAL] = mpTempTotal;


	// 从存盘属性中取出基本属性
	foreach( mixed key in all_base_att_key_summ )
	{
		mpTempBase[key] = mpPermVar[key];
	}

	mpTempTotal[I_A_JINGJIE_KEY] = iJingjie;

	// 默认暴击程度
	// 物理暴击度
	mpTempBase[R_A_WULI_BAOJIDU_KEY] = 500;
	// 法术暴击度
	mpTempBase[R_A_FASHU_BAOJIDU_KEY] = 500;

	foreach( mixed key in all_base_att_key_summ)
	{
		mpTempTotal[key] = to_int(mpTempBase[key] + mpTempAchive[key] + mpTempEquip[key] + mpTempStatus[key]);
	}

	// set mpAchieve
	// set mpEquip
	// set mpStatus
	// 技能
	SKILL_UTIL->AffectBaseAttribute( summid, 0, mpTempVar);

	// 图饰对基本属性的影响
	SUMMON_TATTOO_MAIN->AffectBaseAttribute( summid, mpTempVar);

	// 初血
	iChuzhi = mpTempTotal[I_SUMM_INI_HP];
	// 血资质
	iZizhi = mpTempTotal[I_SUMM_ZZ_HP];
	// 境界成长率
	iJingjieLv = mpAttribInfo[iGrade]["grade"]*mpRealmInfo[iJingjie]["kangxing_grow"];

	iValue = to_int(((100.0 + iGrade * (iZizhi / 100.0) * iChuzhi) * iJingjieLv / 2.0)*1.8);       /*血*/
	mpTempBase[I_A_HP_MAX_KEY] = iValue;

	// 初法
	iChuzhi = mpTempTotal[I_SUMM_INI_MP];
	// 法资质 
	iZizhi = mpTempTotal[I_SUMM_ZZ_MP];
	iValue = to_int((100.0 + iGrade * (iZizhi / 100.0) * iChuzhi) * iJingjieLv / 2.0);       /*法*/
	mpTempBase[I_A_MP_MAX_KEY] = iValue;

	// 初攻
	iChuzhi = mpTempTotal[I_SUMM_INI_ATT];
	// 攻资质
	iZizhi = mpTempTotal[I_SUMM_ZZ_ATT];
	iValue = to_int((100.0 + iGrade * (iZizhi / 100.0) * iChuzhi) * iJingjieLv / 6.0);       /*攻击*/
	mpTempBase[I_A_ATT_KEY] = iValue;

	// 初防
	iChuzhi = mpTempTotal[I_SUMM_INI_FANGYU];
	// 防御资质
	iZizhi = mpTempTotal[I_SUMM_ZZ_FANGYU];
	iValue = to_int((100.0 + iGrade * (iZizhi / 100.0) * iChuzhi) * iJingjieLv / 6.0);       /*防御*/
	mpTempBase[I_A_FANGYU_KEY] = iValue;

	// 强地 水 风 火
	iChuzhi = mpTempTotal[I_SUMM_INI_QIANGFA];
	iZizhi = mpTempTotal[I_SUMM_ZZ_QIANGFA];
	iValue = to_int((100.0 + iGrade * (iZizhi*iChuzhi/ 100.0)) * iJingjieLv / 6.0);
	foreach ( mixed key in ALL_QIANGFA_KEYS )
	{
		mpTempBase[key] = iValue;
	}	
	// 抗地 水 风 火
	iChuzhi = mpTempTotal[I_SUMM_INI_KANGFA];
	iZizhi = mpTempTotal[I_SUMM_ZZ_KANGFA];
	iValue = to_int((100.0 + iGrade * (iZizhi*iChuzhi/ 100.0)) * iJingjieLv / 6.0);
	foreach ( mixed key in ALL_KANGFA_KEYS )
	{
		mpTempBase[key] = iValue;
	}	

	// 初速
	iChuzhi = mpTempTotal[I_SUMM_INI_SPE];
	// 速度资质
	iZizhi = mpTempTotal[I_SUMM_ZZ_SPE];
	// 境界成长率
	iJingjieLv = mpAttribInfo[iGrade]["speed"]*mpRealmInfo[iJingjie]["shuxing_grow"];

	iValue = to_int((10.0 + pow(6.0 * iGrade * (iZizhi / 100.0) * iChuzhi, 0.5)) * iJingjieLv);       /*速度*/
	mpTempBase[I_A_SPE_KEY] = iValue;
	
	foreach( mixed key in all_calc_att_key_summ)
	{
		mpTempTotal[key] = mpTempBase[key];
	}

	// 灵兽的基本属性，在技能前结算
	"data/summon_qinmi"->AffectAttribute(summid, mpTempVar);

	// 技能
	SKILL_UTIL->AffectAttribute( summid, 0, mpTempVar);

	// 图饰对二次属性的影响
	SUMMON_TATTOO_MAIN->AffectAttribute( summid, mpTempVar);
	

	// 当前血法的处理
	/*
	if ( mpPermVar[I_SUMM_CUR_HP] > mpTempTotal[I_A_HP_MAX_KEY] )
	{
		mpPermVar[I_SUMM_CUR_HP] = (mpTempTotal[I_A_HP_MAX_KEY]);
		mpTempTotal[I_FWVK_CUR_HP] = mpPermVar[I_SUMM_CUR_HP];
	}
	if ( mpPermVar[I_SUMM_CUR_MP] > mpTempTotal[I_A_MP_MAX_KEY] )
	{
		mpPermVar[I_SUMM_CUR_MP] = (mpTempTotal[I_A_MP_MAX_KEY]);
		mpTempTotal[I_FWVK_CUR_MP] = mpPermVar[I_SUMM_CUR_MP];
	}
	*/

	mpPermVar[I_SUMM_CUR_HP] = (mpTempTotal[I_A_HP_MAX_KEY]);
	mpTempTotal[I_FWVK_CUR_HP] = mpPermVar[I_SUMM_CUR_HP];
	
	mpPermVar[I_SUMM_CUR_MP] = (mpTempTotal[I_A_MP_MAX_KEY]);
	mpTempTotal[I_FWVK_CUR_MP] = mpPermVar[I_SUMM_CUR_MP];

	if ( mpPermVar[I_SUMM_CUR_HP] == 0)
	{
		mpPermVar[I_SUMM_CUR_HP] = (mpTempTotal[I_A_HP_MAX_KEY]);
		mpTempTotal[I_FWVK_CUR_HP] = mpPermVar[I_SUMM_CUR_HP];
	}

	FightingPoint(summid);

	calculatingSumm = 0;
	return 1;
}

int GetSummonRace(int summid)
{
	int iType;

	iType = GetSummonSave(summid, I_SUMM_TYPE);

	if (undefinedp(mpSummonProp[iType])) {
		debug_message(sprintf("灵兽iType[%d] 不存在[%O]", iType, get_summon_map(summid, 1)));
		return 0;
	}
	return mpSummonProp[iType][SUMMON_RACE];
}

int GetSummonTypical(int summid)
{
	int iType = GetSummonSave(summid, I_SUMM_TYPE);
	return mpSummonProp[iType][SUMMON_TYPICAL];
}

mapping GetBaseSummonProp(int iType)
{
	return mpSummonProp[iType];
}

private varargs mapping _ResetTalent(int summid, int iForceRate)
{
	int iTypical, iGrow;
	int iRace, iType;
	int iKangRate, iQiangRate, iZZRate, iIniRate;

	iType = GetSummonSave(summid, I_SUMM_TYPE);
	iGrow = GetSummonSave(summid, I_SUMM_GROW);

	int iBase = 80;
	iBase += GetSummonSave(summid, I_SUMM_LIANYAO)/100;
	if ( iBase > 90 ) iBase = 90;
	int iRandom = 100 - iBase + 1;

	mapping mpTalents = ([]);

	// 资质 80-100%
	foreach ( mixed key in ({I_SUMM_ZZ_HP, I_SUMM_ZZ_MP, I_SUMM_ZZ_ATT, I_SUMM_ZZ_FANGYU, I_SUMM_ZZ_SPE,}) ) // 资质
	{
		iZZRate = iForceRate?iForceRate:(iBase+random(iRandom));
		mpTalents[key] = (mpSummonProp[iType][key]*mpGrowInfo[iGrow]["rate"]/100)*iZZRate/100;
	}
	// qiang资质 // 4项同一个规则
	iQiangRate = iForceRate?iForceRate:(iBase+random(iRandom));
	mpTalents[I_SUMM_ZZ_QIANGFA] = (mpSummonProp[iType][I_SUMM_ZZ_QIANGFA]*mpGrowInfo[iGrow]["rate"]/100)*iQiangRate/100; 
	// kang 资质 // 4项同一个规则
	iKangRate = iForceRate?iForceRate:(iBase+random(iRandom));
	mpTalents[I_SUMM_ZZ_KANGFA] = (mpSummonProp[iType][I_SUMM_ZZ_KANGFA]*mpGrowInfo[iGrow]["rate"]/100)*iQiangRate/100;
	// 慧根 ini...
	foreach ( mixed key in ({ I_SUMM_INI_HP, I_SUMM_INI_MP, I_SUMM_INI_ATT, I_SUMM_INI_FANGYU, I_SUMM_INI_SPE, }) )
	{
		iIniRate = iForceRate?iForceRate:(iBase+random(iRandom));
		mpTalents[key] = mpSummonProp[iType][key]*(iIniRate)/100;
	}
	iQiangRate = iForceRate?iForceRate:(iBase+random(iRandom));
	mpTalents[I_SUMM_INI_QIANGFA] = mpSummonProp[iType][I_SUMM_INI_QIANGFA]*iQiangRate/100;
	iKangRate = iForceRate?iForceRate:(iBase+random(iRandom));
	mpTalents[I_SUMM_INI_KANGFA] = mpSummonProp[iType][I_SUMM_INI_KANGFA]*iKangRate/100;

	return mpTalents;
}	

// 重置灵兽的天赋
varargs void ResetSummonTalent(int summid, int iForceRate)
{
	foreach( mixed key, mixed value in _ResetTalent(summid, iForceRate) )
	{
		SetSummonSave(summid, key, value);
	}
}

// 洗灵兽的天赋，不确定是否重置
varargs void V_ResetSummonTalent(int summid)
{
	foreach( mixed key, mixed value in _ResetTalent(summid) )
	{
		SetSummonTemp(summid, key, value);
	}
}

void CheckTalentAchieve(object oUser, int summid)
{
	int iAchieve = 0;
	int iGrow = GetSummonSave(summid, I_SUMM_GROW);
	mapping mpTmp = mpSummonProp[GetSummonSave(summid, I_SUMM_TYPE)];
	mapping arg = ([]);

	if ( !mapp(mpTmp) ) 
	{
		return;
	}

	mapping mpTalents = ([]);

	foreach( mixed key in TALENT_KEYS ) 
	{	
		mpTalents[key] = GetSummonTemp(summid, key) ? GetSummonTemp(summid, key) : GetSummonSave(summid, key);
	}

	foreach ( mixed key in ({
				I_SUMM_ZZ_HP, I_SUMM_ZZ_MP, I_SUMM_ZZ_ATT, I_SUMM_ZZ_FANGYU, I_SUMM_ZZ_SPE,
				I_SUMM_ZZ_QIANGFA, I_SUMM_ZZ_KANGFA,
								}) ) // 资质 + 慧根
	{
		if ( mpTalents[key] < to_int(mpTmp[key]*mpGrowInfo[iGrow]["rate"]/100))
		{	
			continue;
		}

		iAchieve ++;
	}

	foreach ( mixed key in ({
				I_SUMM_INI_HP, I_SUMM_INI_MP, I_SUMM_INI_ATT, I_SUMM_INI_FANGYU, I_SUMM_INI_SPE, 
				I_SUMM_INI_QIANGFA, I_SUMM_INI_KANGFA,
				}) )
	{
		if ( mpTalents[key] < mpTmp[key])
		{
			continue;
		}

		iAchieve ++;
	}

	arg[AK_SUMMON_HIGH_TALENT] = iAchieve;
	oUser->StatsGroupExec(ACH_SUMMON_TALENT, 1, arg);
}

// 由无到有：生成灵兽(初值，资质(成长率), 初始技能, 技能库)
varargs int NewSummon(int iType, int iGrow)
{
	int summid;

	int iTypical;
	int iRace, iRealm;
	int iKangRate, iQiangRate;

	if (undefinedp(mpSummonProp[iType])) {
		debug_message(sprintf("灵兽类型[%d]不存在!", iType));
		return 0;
	}

	summid = new_summon(SUMMON_PATH);
	if (!summid) {
		debug_message("无法生成灵兽!");
		return 0;
	}

	if (!iGrow) iGrow = 1;
	assert( iGrow >= 1 && iGrow <= 3 );

	SetSummonSave(summid, I_SUMM_TYPE, iType);
	SetSummonSave(summid, C_SUMM_NAME, GetNameByType(iType) );
	SetSummonSave(summid, I_SUMM_GRADE, 1);     /*等级*/
	SetSummonSave(summid, I_SUMM_GROW, iGrow);
	//SetSummonSave(summid, I_SUMM_LIFE, GetLifeByType(iType)); 
	iRealm = GetRealmByType(iType);
	SetSummonSave(summid, I_SUMM_LIFE, (2300-iRealm*300)+random(501)); 

	SetSummonTemp(summid, I_T_SUMM_REALM, 1); 
	SetSummonTemp(summid, I_T_GROW_COLOR, GetSummonColor(summid));

	SetSummonSave(summid, M_SUMM_SKILL_GRID, ([]));
	SetSummonSave(summid, I_SUMM_RES, mpSummonProp[iType][I_SUMM_RES]);     /*资源ID*/

	ResetSummonTalent(summid);
	Import("SUMMON_SKILL")->ResetSummonSkills(summid);

	CalSummon(summid);

	SetSummonSave( summid, I_SUMM_CUR_HP, GetSummonFightValue( summid, I_A_HP_MAX_KEY) );
	SetSummonSave( summid, I_SUMM_CUR_MP, GetSummonFightValue( summid, I_A_MP_MAX_KEY) );

	return summid;
}

void OnAddSummonAch(object oUser, int summid)
{
	mapping arg = ([]);
	arg[AK_SUMMON_GROW] = GetSummonSave(summid, I_SUMM_GROW);
	arg[AK_SUMMON_RARITY] = GetRarity( GetSummonSave(summid, I_SUMM_TYPE) );
	oUser->StatsGroupExec( ACH_SUMMON_AMOUNT, 1, arg);
}	

// 给予玩家灵兽的统一入口(判断境界等)
int AddSummon(object oUser, int summid)
{
	int ret, uid, iRealm;
	int type = GetSummonSave(summid, I_SUMM_TYPE);

	uid = oUser->GetId();
	iRealm = GetRealmByType(type);
	assert(iRealm);

	if ( oUser->GetiJingjie() < iRealm )
	{
		oUser->TellMe("灵兽不能超过人物境界，获得灵兽失败。");
		destroy_summon(summid);
		return 0;
	}	
	
	
	ret = oUser->AddSummonToBag(summid, SUMMON_BAG_NORMAL);
	if (!ret) 
	{
		// debug_message(sprintf("玩家[%d]添加灵兽[%O]失败!", uid, get_summon_map(summid, 1)));
		oUser->TellMe("灵兽背包满，添加失败。");
		destroy_summon(summid);
		return 0;
	}

	if ( GetSummonSave(summid, C_GLOBAL_KEY) == "" )
	{
		string cGblKey = Import("GLOBAL_KEY")->new_summon_globalkey();	
		SetSummonSave(summid, C_GLOBAL_KEY, cGblKey);
		logger->Log("[%d]AddSummon,summid=%d, type=%d, global_key=%s.", uid,summid, GetSummonSave(summid, I_SUMM_TYPE), GetSummonSave(summid, C_GLOBAL_KEY) );
		logger->DB(add_summon_key, uid, GetSummonSave(summid, C_GLOBAL_KEY), GetSummonSave(summid, I_SUMM_TYPE));
		// 新增的灵兽GBLKEY添加到玩家身上
		mapping mpGblKeys = oUser->GetTemp(M_T_SUMMON_GLOBAL_ID);
		if(undefinedp(mpGblKeys[cGblKey])) {
			mpGblKeys[cGblKey] = summid;
		}
	}

	OnAddSummonAch(oUser, summid );

	rpc_SummonInfo(uid, summid);
	return summid;
}

void rpc_SummonLife(int uid,int summid)
{
	rpc_client_summon_iprop(uid, summid, "iLife", GetSummonSave(summid, I_SUMM_LIFE) );
}

string * GetAllSkill( int summid )
{
	// M_SUMM_TALENTSKILLS
	// M_SUMM_SKILLS
	mapping summSkill = GetSummonSave(summid, M_SUMM_SKILLS);
	mapping talentSkill = GetSummonSave(summid, M_SUMM_TALENTSKILLS);
	mapping allSkill = ([]);
	string skillPath, skillId;
	object oFile;

	foreach ( mapping mpTmpSkill in ({ summSkill, talentSkill }) )
	{	
		foreach(string skill, int iLevel in mpTmpSkill)
		{
			skillId = sprintf("%s%d", skill, iLevel);
			skillPath = SKILL_PATH + skillId;
			oFile = find_object(skillPath, 1);

			if ( !objectp( oFile ) )
			{
				debug_message( sprintf("ERROR:tell prophet[%s]不存在", skillPath) );
				continue;
			}

			allSkill[skillId] = 1;
		}
	}

	return keys(allSkill);
}

mapping GetAllSkillMap( int summid )
{
	// M_SUMM_TALENTSKILLS
	// M_SUMM_SKILLS
	mapping summSkill = GetSummonSave(summid, M_SUMM_SKILLS);
	mapping talentSkill = GetSummonSave(summid, M_SUMM_TALENTSKILLS);
	mapping allSkill = ([]);
	string skillPath, skillId;
	object oFile;

	foreach ( mapping mpTmpSkill in ({ summSkill, talentSkill }) )
	{	
		foreach(string skill, int iLevel in mpTmpSkill)
		{
			skillId = sprintf("%s%d", skill, iLevel);
			skillPath = SKILL_PATH + skillId;
			oFile = find_object(skillPath, 1);

			if ( !objectp( oFile ) )
			{
				debug_message( sprintf("ERROR:tell prophet[%s]不存在", skillPath) );
				continue;
			}

			allSkill[skillId] = 1;
		}
	}

	return allSkill;
}

// 删除灵兽的统一入口
varargs int RemoveSummon(object oUser, int summid, int iNotDestroy )
{
	int iBagId, iPos, iRes;

	iPos = GetSummonTemp(summid, I_T_SUMM_POS);
	iBagId = GetSummonTemp(summid, I_T_SUMM_BAG);

	if ( oUser->GetShowSummon() == summid )
	{
		oUser->HideSummon();
	}

	if ( oUser->GetFightSummon() == GetSummonSave(summid, C_GLOBAL_KEY) )
	{
		oUser->UnsetFightSummon();
		rpc_client_set_summon_fight(oUser->GetId(), 0); 
	}	

	iRes = oUser->RemoveSummonFromBag(summid);

	if ( iRes )
	{	
		rpc_client_summon_del(oUser->GetId(), summid);
		// rpc_DelSummon(usernum, iSummon);
	}	

	SetSummonTemp( summid, I_T_SUMM_POS, 0);
	SetSummonTemp( summid, I_T_SUMM_BAG, 0);

	// debug_message(sprintf("RemoveSummon %x from %d,(%d,%d)", summid, oUser->GetId(), iBagId, iPos));
	"module/rank/summon"->DelSummon(oUser, summid);
	
	if( !iNotDestroy )
	{
		destroy_summon(summid);
	}
	
	return 1;
}

class summon_talent_t summon_talent(int summonid)
{
	class summon_talent_t _talent;

	_talent = new( class summon_talent_t );

	_talent->zz_hp = GetSummonSave( summonid, I_SUMM_ZZ_HP);
	_talent->zz_mp = GetSummonSave( summonid, I_SUMM_ZZ_MP);
	_talent->zz_att = GetSummonSave( summonid, I_SUMM_ZZ_ATT);
	_talent->zz_fangyu = GetSummonSave( summonid, I_SUMM_ZZ_FANGYU);
	_talent->zz_spe = GetSummonSave( summonid, I_SUMM_ZZ_SPE);

	_talent->zz_qiangfa = GetSummonSave( summonid, I_SUMM_ZZ_QIANGFA);
	_talent->zz_kangfa = GetSummonSave( summonid, I_SUMM_ZZ_KANGFA);
	/*
	_talent->zz_qiangdi = GetSummonSave( summonid, I_SUMM_ZZ_QIANGDI);
	_talent->zz_qiangshui = GetSummonSave( summonid, I_SUMM_ZZ_QIANGSHUI);
	_talent->zz_qianghuo = GetSummonSave( summonid, I_SUMM_ZZ_QIANGHUO);
	_talent->zz_qiangfeng = GetSummonSave( summonid, I_SUMM_ZZ_QIANGFENG);

	_talent->zz_kangdi = GetSummonSave( summonid, I_SUMM_ZZ_KANGDI);
	_talent->zz_kangshui = GetSummonSave( summonid, I_SUMM_ZZ_KANGSHUI);
	_talent->zz_kanghuo = GetSummonSave( summonid, I_SUMM_ZZ_KANGHUO);
	_talent->zz_kangfeng = GetSummonSave( summonid, I_SUMM_ZZ_KANGFENG);
	*/

	_talent->ini_hp = GetSummonSave( summonid, I_SUMM_INI_HP);
	_talent->ini_mp = GetSummonSave( summonid, I_SUMM_INI_MP);
	_talent->ini_att = GetSummonSave( summonid, I_SUMM_INI_ATT);
	_talent->ini_fangyu = GetSummonSave( summonid, I_SUMM_INI_FANGYU);
	_talent->ini_spe = GetSummonSave( summonid, I_SUMM_INI_SPE);

	_talent->ini_qiangfa = GetSummonSave( summonid, I_SUMM_INI_QIANGFA);
	_talent->ini_kangfa = GetSummonSave( summonid, I_SUMM_INI_KANGFA);
	/*
	_talent->ini_qiangdi = GetSummonSave( summonid, I_SUMM_INI_QIANGDI);
	_talent->ini_qiangshui = GetSummonSave( summonid, I_SUMM_INI_QIANGSHUI);
	_talent->ini_qianghuo = GetSummonSave( summonid, I_SUMM_INI_QIANGHUO);
	_talent->ini_qiangfeng = GetSummonSave( summonid, I_SUMM_INI_QIANGFENG);

	_talent->ini_kangdi = GetSummonSave( summonid, I_SUMM_INI_KANGDI);
	_talent->ini_kangshui = GetSummonSave( summonid, I_SUMM_INI_KANGSHUI);
	_talent->ini_kanghuo = GetSummonSave( summonid, I_SUMM_INI_KANGHUO);
	_talent->ini_kangfeng = GetSummonSave( summonid, I_SUMM_INI_KANGFENG);
	*/

	_talent->lianyao= GetSummonSave( summonid, I_SUMM_LIANYAO);

	return _talent;	
}	

class summon_talent_t summon_v_talent(int summonid)
{
	class summon_talent_t _talent;

	_talent = new(class summon_talent_t);

	_talent->zz_hp = GetSummonTemp(summonid, I_SUMM_ZZ_HP);
	_talent->zz_mp = GetSummonTemp(summonid, I_SUMM_ZZ_MP);
	_talent->zz_att = GetSummonTemp(summonid, I_SUMM_ZZ_ATT);
	_talent->zz_fangyu = GetSummonTemp(summonid, I_SUMM_ZZ_FANGYU);
	_talent->zz_spe = GetSummonTemp(summonid, I_SUMM_ZZ_SPE);
	_talent->zz_qiangfa = GetSummonTemp(summonid, I_SUMM_ZZ_QIANGFA);
	_talent->zz_kangfa = GetSummonTemp(summonid, I_SUMM_ZZ_KANGFA);
	_talent->ini_hp = GetSummonTemp(summonid, I_SUMM_INI_HP);
	_talent->ini_mp = GetSummonTemp(summonid, I_SUMM_INI_MP);
	_talent->ini_att = GetSummonTemp(summonid, I_SUMM_INI_ATT);
	_talent->ini_fangyu = GetSummonTemp(summonid, I_SUMM_INI_FANGYU);
	_talent->ini_spe = GetSummonTemp(summonid, I_SUMM_INI_SPE);
	_talent->ini_qiangfa = GetSummonTemp(summonid, I_SUMM_INI_QIANGFA);
	_talent->ini_kangfa = GetSummonTemp(summonid, I_SUMM_INI_KANGFA);
	_talent->lianyao = GetSummonSave( summonid, I_SUMM_LIANYAO); // lianyao值当作session key

	return _talent;	
}

void rpc_SummonTalent( int uid, int summonid)
{
	rpc_client_summon_talent(uid, summonid, summon_talent(summonid) );
}

void rpc_V_SummonTalent( int uid, int summonid)
{
	rpc_client_summon_v_talent(uid, summonid, summon_v_talent(summonid) );
}

class summon_skill_t summon_skill(int summonid)
{
	string * Skills = ({});
	string * SkillLib;
	mapping mpTalentSkills;
	string * TalentSkills = ({ });
	mapping mpSkill;
	class summon_skill_t _skill;

	_skill = new( class summon_skill_t );

	Import("SUMMON_SKILL")->AllSkillGrids(summonid);
	Skills = GetSummonTemp(summonid, A_T_SUMM_SKILL);
	/*
	mpSkill = GetSummonSave(summonid, M_SUMM_SKILLS);
	foreach (string skill, int iLevel in mpSkill)
		Skills += ({ sprintf("%s%d", skill, iLevel) });
	*/
	SkillLib = GetSummonSave(summonid, A_SUMM_SKILL_LIB);
	mpTalentSkills = GetSummonSave(summonid, M_SUMM_TALENTSKILLS);
	foreach (string skill, int iLevel in mpTalentSkills)
		TalentSkills += ({ sprintf("%s%d", skill, iLevel) });

	_skill->Skills = Skills;
	_skill->SkillLib = SkillLib;
	_skill->TalentSkills = TalentSkills;

	return _skill;
}

void rpc_SummonSkill( int uid, int summonid)
{
	rpc_client_summon_skills(uid, summonid, summon_skill(summonid) );
}


class summon_element_t summon_element(int summonid)
{
	class summon_element_t _element;

	_element = new(class summon_element_t);

	//_element->phy_baoji = GetSummonFightValue(summonid, I_A_WULI_BAOJIJI_KEY);
	_element->phy_baoji_rate = GetSummonFightValue(summonid, R_A_WULI_BAOJIDU_KEY);
	_element->pofang = GetSummonFightValue(summonid, I_A_WULI_POFANG_KEY);
	_element->phy_anti = GetSummonFightValue(summonid, I_A_WULI_MIANYI_KEY);

	//_element->magic_baoji = GetSummonFightValue(summonid, I_A_FASHU_BAOJI_KEY);
	_element->magic_baoji_rate = GetSummonFightValue(summonid, R_A_FASHU_BAOJIDU_KEY);
	_element->magic_chuantou = GetSummonFightValue(summonid, I_A_FASHU_CHUANTOU_KEY);
	_element->magic_kangxing = GetSummonFightValue(summonid, I_A_FASHU_KANGXING_KEY);
	//debug_message( sprintf("phy baoji %d,%d, magic baoji %d,%d", _element->phy_baoji,  _element->phy_baoji_rate, _element->magic_baoji,  _element->magic_baoji_rate) );

	return _element;
}

void rpc_SummonElement( int uid, int summonid)
{
	rpc_client_summon_element(uid, summonid, summon_element(summonid) );
}


static int lastOpSummon = 0;
static mapping tmpFightValue;

int GetSummonFightValue( int summonId, mixed key )
{
	if ( lastOpSummon != summonId )
	{
		mapping mpData = get_summon_map(summonId, TEMP_VAR);
		if ( undefinedp(mpData)) return 0;

		tmpFightValue = get_summon_map(summonId, TEMP_VAR)[A_K_TOTAL];
	}

	return tmpFightValue[key];
}

int GetResId(int summonid)
{
	int iResId = GetSummonSave(summonid, I_SUMM_RES);

	return iResId ? iResId : mpSummonProp[GetSummonSave(summonid, I_SUMM_TYPE)][I_SUMM_RES];
}	

class summon_t summon_info_pack(int summid)
{
	class summon_t _summon_info = new(class summon_t);
	int iType = GetSummonSave(summid, I_SUMM_TYPE);

	mapping _mpInfo = mpSummonProp[iType];

	_summon_info->summid = summid;
	_summon_info->resid = GetResId(summid);
	_summon_info->typeid = iType;

	_summon_info->pos = GetSummonTemp(summid, I_T_SUMM_POS);
	_summon_info->lockinfo = GetSummonSave(summid, I_SUMM_LOCK);

	_summon_info->name = GetSummonSave(summid, C_SUMM_NAME);
	_summon_info->jingjie = GetSummonTemp(summid, I_T_SUMM_REALM);
	//_summon_info->race = _mpInfo[SUMMON_RACE];
	//_summon_info->typical = _mpInfo[SUMMON_TYPICAL];
	_summon_info->grade = GetSummonSave(summid, I_SUMM_GRADE);
	_summon_info->life = GetSummonSave(summid, I_SUMM_LIFE);
	_summon_info->grow = GetSummonSave(summid, I_SUMM_GROW);

	_summon_info->exp = to_int(GetSummonSave(summid, I_SUMM_EXP));
	//_summon_info->exp_next = GetSummonTemp(summid, I_T_SUMM_EXP_NEXT);

	_summon_info->hp = GetSummonSave(summid, I_SUMM_CUR_HP);
	_summon_info->maxhp = GetSummonFightValue( summid, I_A_HP_MAX_KEY);
	_summon_info->mp = GetSummonSave(summid, I_SUMM_CUR_MP);
	_summon_info->maxmp = GetSummonFightValue(summid, I_A_MP_MAX_KEY);
	_summon_info->att = GetSummonFightValue(summid, I_A_ATT_KEY);
	_summon_info->spe = GetSummonFightValue(summid, I_A_SPE_KEY);
	_summon_info->def = GetSummonFightValue(summid, I_A_FANGYU_KEY);

	_summon_info->qiangdi = GetSummonFightValue(summid, I_A_QIANGDI_KEY);
	_summon_info->qiangshui = GetSummonFightValue(summid, I_A_QIANGSHUI_KEY);
	_summon_info->qianghuo = GetSummonFightValue(summid, I_A_QIANGHUO_KEY);
	_summon_info->qiangfeng = GetSummonFightValue(summid, I_A_QIANGFENG_KEY);

	_summon_info->kangdi = GetSummonFightValue(summid, I_A_KANGDI_KEY);
	_summon_info->kangshui = GetSummonFightValue(summid, I_A_KANGSHUI_KEY);
	_summon_info->kanghuo = GetSummonFightValue(summid, I_A_KANGHUO_KEY);
	_summon_info->kangfeng = GetSummonFightValue(summid, I_A_KANGFENG_KEY);

	// 图饰
	{
		mixed* allTattoo = GetSummonSave(summid, A_SUMM_TATTOO ); 

		if ( sizeof( allTattoo ))
		{
			_summon_info->tattooId = atoi( allTattoo[0][TATTOO_ID_INDEX] );
			_summon_info->tattooTO = allTattoo[0][TATTOO_TIMEOUT_INDEX];
		}
	}
	
	_summon_info->fightpoint = GetSummonTemp(summid, I_T_SUMM_FIGHTPOINT);

	// 暴击和法暴
	_summon_info->phy_baoji = GetSummonFightValue(summid, I_A_WULI_BAOJIJI_KEY);
	_summon_info->magic_baoji = GetSummonFightValue(summid, I_A_FASHU_BAOJI_KEY);
	_summon_info->qinmi = GetSummonSave(summid, I_SUMM_QINMI);

	return _summon_info;
}

void rpc_SummonInfo(int uid, int summid)
{
	class summon_t _summon = summon_info_pack(summid);

	// debug_message( sprintf("rpc_summonifo %O", _summon) );
	rpc_client_summon_info(uid, _summon, summon_skill(summid) );

	/*
	// 新手目标统计 灵兽亲密度
	object oUser = get_user(uid);
	if(objectp(oUser)) {
		SummonQinmiNewbieAch(oUser, _summon->qinmi);
	}
	*/
}	

int SetFightSummon( object oUser, int summonid)
{
	int iRes;

	if ( GetSummonSave( summonid, I_SUMM_LIFE) < 1 )
	{
		oUser->TellMe("灵兽寿命过低，无法参战");
		return 0;
	}

	/*
	if ( GetSummonTemp(summonid, I_T_SUMM_REALM) > oUser->GetiJingjie() )
	{
		oUser->TellMe("灵兽境界大于人物境界，无法参战");
		return 0;
	}
	*/

	/*
	if ( GetSummonSave(summonid, I_SUMM_GRADE) > oUser->GetiGrade() )
	{
		oUser->TellMe("灵兽级别过高，无法参战");
		return 0;
	}
	*/

	iRes = oUser->SetFightSummon(summonid);

	int teamid = get_user_teamid(oUser->GetId());
	if (teamid) {
		Import("TEAM")->BroadCastTeamInfo(teamid);
	}
	Import("COMMON_HOOK")->SetSummonFight(oUser, summonid);
	rpc_client_set_summon_fight(oUser->GetId(), iRes);

	// 新手目标统计 灵兽出战
	SetFightSummonAch(oUser);

	return iRes;
}

void UnsetFightSummon(object oUser)
{
	oUser->UnsetFightSummon();
	rpc_client_set_summon_fight(oUser->GetId(), 0);
}

void do_destroy_summon(int iSummonid)
{
	destroy_summon(iSummonid);
}

int RestoreSummon(mapping mpSave)
{
	int iType = mpSave[I_SUMM_TYPE];
	int iSummon;


	iSummon = restore_summon(SUMMON_PATH, mpSave);

	if ( iSummon < 0) 
	{
		debug_message( sprintf("ERROR:Restore Summon失败！%O", mpSave) );
		return iSummon;
	}
	
	CalSummon(iSummon);
	//Import("SUMMON_SKILL")->AllSkillGrids();

	//debug_message( sprintf("RestoreSummon %d, %s\n", iSummon, GetSummonSave(iSummon, C_GLOBAL_KEY) ) );

	return iSummon;
}

// ================================================
// rpc
void rpc_DelSummon( int usernum, int iSummon)
{	
	rpc_client_summon_del(usernum, iSummon);
}

void rpc_SummonPos(int usernum, int iSummon)
{
	rpc_client_summon_pos( usernum, iSummon, GetSummonTemp(iSummon, I_T_SUMM_POS) );
}

int * SummonWuxingInfos(int summid)
{
	int * Infos = allocate(sizeof(mpQinmiKeys));
	mapping mpInfo = GetSummonSave(summid, M_SUMM_QINMI_INFO);
	if ( !mpInfo || !mpInfo["points"] )
		CalQinmiWuxing(summid);

	foreach( string key, mapping _mpTmp in mpQinmiKeys)
	{
		Infos[_mpTmp["pos"]] = mpInfo["points"][key];
	}

	return Infos;
}

int SummonWuxingPoint(int summid)
{
	mapping mpInfo = GetSummonSave(summid, M_SUMM_QINMI_INFO);
	if ( !mpInfo || !mpInfo["points"] )
	{	
		CalQinmiWuxing(summid);
		mpInfo = GetSummonSave(summid, M_SUMM_QINMI_INFO);
	}	

	return mpInfo["total"];
}

void rpc_SummonWuxing(int uid, int summid)
{
	rpc_client_summon_iprop(uid, summid, "iWuxing", SummonWuxingPoint(summid));
	rpc_client_summon_qinmi_info(uid, summid, SummonWuxingInfos(summid));
}


// 同步灵兽信息, 登录时候发送
void SyncAllSummonToClient(object oUser, int iBagId)
{
	if ( iBagId != SUMMON_BAG_NORMAL )
		return ;

	int *summonids = oUser->GetAllSummons(iBagId);
	int uid = oUser->GetId();
	// rpc_client_allsummons(oUser, summonids);

	foreach (int summid in summonids) 
	{
		rpc_SummonInfo(uid, summid);
		// 兼容客户端逻辑
		rpc_SummonElement(uid, summid);
		// 2012年1月5号之后可以删掉 同时修改成就表，将OP_SET改成OP_ADD
		if ( GetSummonSave(summid, I_SUMM_GROW) == 4 )
		{
			mapping arg = ([]);
			arg[AK_SUMMON_GROW] = 4;
			oUser->StatsGroupExec( ACH_SUMMON_AMOUNT, 1, arg);

		}

		/*
		// 新手目标统计 精良灵兽、珍稀灵兽
		SummonGrowNewbieAch(oUser, summid);
		// 新手目标统计 灵兽技能数量
		SummonSkillCntNewbieAch(oUser, summid);
		// 新手目标统计 灵兽激活六个四级技能
		SummonSkillLvAch(oUser, summid);
		*/

		// 新手目标统计 拥有一只蓝品质灵兽，并且缘生境界和旋照境界的技能满
		BlueSummonYuanshengXuanzhaoSkillAch(oUser, summid);
	}
}

class summon_skill_t ShoulongSkillClass(mapping mpSkillInfo)
{
	string * Skills = ({});
	string * SkillLib,* TalentSkills = ({ });
	mapping mpSkill, mpTalentSkill;

	mpSkill = mpSkillInfo[M_SUMM_SKILLS];
	foreach (string skill, int iLevel in mpSkill)
		Skills += ({ sprintf("%s%d", skill, iLevel) });

	SkillLib = mpSkillInfo[A_SUMM_SKILL_LIB];
	mpTalentSkill = mpSkillInfo[M_SUMM_TALENTSKILLS];
	foreach (string skill, int iLevel in mpTalentSkill)
		TalentSkills += ({ sprintf("%s%d", skill, iLevel) });

	class summon_skill_t _skill;
	_skill = new( class summon_skill_t );

	_skill->Skills = Skills;
	_skill->SkillLib = SkillLib;
	_skill->TalentSkills = TalentSkills;

	return _skill;
}

void ShoulongInfo(object oUser, int iItem)
{
	int iType;
	int iGrow;

	mapping mpSkillInfo = GetItemSave(iItem, M_SHOULONG_SUMMSKILLS);

	if ( undefinedp(mpSkillInfo) )
	{
		oUser->TellMe("无效兽笼。");
		return ;
	}	

	iType = GetItemSave(iItem, I_SHOULONG_SUMMTYPE);
	iGrow = GetShoulongGrow( iItem );

	rpc_client_summon_shoulong_info( oUser->GetId(), iType, iGrow, ShoulongSkillClass(mpSkillInfo) );
}

mapping GetShoulongInfo(int iItem)
{
	int iType;
	int iGrow;

	mapping mpSkillInfo = GetItemSave(iItem, M_SHOULONG_SUMMSKILLS);

	if ( undefinedp(mpSkillInfo) )
	{
		return ([]);
	}	

	iType = GetItemSave(iItem, I_SHOULONG_SUMMTYPE);
	iGrow = GetShoulongGrow( iItem );

	return (["type": iType, "grow": iGrow, "skill": ShoulongSkillClass(mpSkillInfo) ]);
}

/*
string ShoulongItemStringByMap(mapping save_map)
{
	mapping mpSkillInfo;
	string cRes = "";
	string cStr = "";

	cStr = mpRarityInfo[GetRarity(save_map[I_SHOULONG_SUMMTYPE])];
	mpSkillInfo = save_map[M_SHOULONG_SUMMSKILLS];

	if (!undefinedp(mpSkillInfo)) {
		int iFightSummon = 0;
		string *MainSkillLib = ({});
		
		if (arrayp(mpSkillInfo[A_SUMM_SKILL_LIB])) {
			foreach (string _skillid in mpSkillInfo[A_SUMM_SKILL_LIB]) {
				int i;
				string _name;
				_name = sprintf("%s%s#n", "#cFF999999", "module/summon/skill"->SkillName(_skillid));
				if (sizeof(cRes))
					cRes = sprintf("%s、%s", cRes, _name);	
				else 
					cRes = _name;
			}
		}
	}

	if (!sizeof(cRes)) {
		cRes = "空";
	}
	return sprintf("#n【稀 有 度】 %s#r【技    囊】 #n%s", cStr, cRes);

}
*/

string ShoulongItemString(object oUser, mapping save_data, mapping temp_data)
{
	mapping mpSkillInfo;
	string cRes = "";
	string cStr = "";
	string _color ;

	cStr = mpRarityInfo[GetRarity(save_data[I_SHOULONG_SUMMTYPE])];

	mpSkillInfo = save_data[M_SHOULONG_SUMMSKILLS];

	if ( !undefinedp(mpSkillInfo) )
	{
		int iFightSummon = 0;
		string *MainSkillLib = ({});
		
		if (objectp(oUser)) {
			iFightSummon = oUser->GetFightSummon();
		}
		if (	iFightSummon 
				&& is_summon_online(iFightSummon)
				//&& GetSummonSave(iFightSummon, I_SUMM_GRADE) >= 10 
				&& GetSummonRace(iFightSummon) == mpSummonProp[save_data[I_SHOULONG_SUMMTYPE]][SUMMON_RACE] 
				&& GetSummonTemp(iFightSummon, I_T_SUMM_REALM) <= oUser->GetiJingjie()
				)
		{
			MainSkillLib = GetSummonSave(iFightSummon, A_SUMM_SKILL_LIB);
			_color = "#B";
		}
		else
		{
			_color = "#cFF999999";
		}	

		//oUser->TellMe( sprintf("%O", MainSkillLib) );

		if ( arrayp(mpSkillInfo[A_SUMM_SKILL_LIB]) )
		{
			foreach ( string _skillid in mpSkillInfo[A_SUMM_SKILL_LIB] )
			{
				int i;
				string _name;
				
				i = iFightSummon && (member_array(_skillid, MainSkillLib) == -1) && Import("SUMMON_SKILL")->CanAddSkillLib(iFightSummon, _skillid, 1);
				_name = sprintf("%s%s#n", i?_color:"#cFF999999", "module/summon/skill"->SkillName(_skillid));

				if ( sizeof(cRes) )
					cRes = sprintf("%s、%s", cRes, _name);	
				else 
					cRes = _name;
			}
		}
	}

	if ( !sizeof(cRes) )
	{
		cRes = "空";
	}

	return sprintf("#n【稀 有 度】 %s#r【技    能】 #n%s", cStr, cRes);
}

int NewShoulong(int iType, int iGrow)
{
	mapping mpSkillRes;
	string cType;
	int iItem, iRace;

	iRace = mpSummonProp[iType][SUMMON_RACE];
	if ( !iGrow ) iGrow = 1;
	int iRealm = mpSummonProp[iType][I_T_SUMM_REALM];
	cType = ShoulongTypeByGrow(iRealm, iGrow, iRace, iType);
	
	iItem = Import("UTIL")->CreateItem(cType);
	if ( iItem == -1 )
		return 0;

	mpSkillRes = Import("SUMMON_SKILL")->GenSummonSkills(iType);
	// set skill info
	SetItemSave(iItem, I_SHOULONG_SUMMTYPE, iType);
	SetItemSave(iItem, M_SHOULONG_SUMMSKILLS, mpSkillRes);

	// debug_message( sprintf("new 兽笼 skills %O", mpSkillRes) );
	return iItem;
}

int RenewShoulong(int iItem)
{
	int iType = GetItemSave(iItem, I_SHOULONG_SUMMTYPE); 
	mapping mpSkillRes = Import("SUMMON_SKILL")->GenSummonSkills(iType);

	SetItemSave(iItem, M_SHOULONG_SUMMSKILLS, mpSkillRes);
}

int NewShoulongByRealm(int iRealm, int iGrow)
{
	int iType = "module/summon/shoulong_info"->RandomSummon(iRealm, iGrow, 0);
	return NewShoulong( iType, iGrow );
}

int NewbieShoulong()
{
	mapping mpSkillRes;
	int iType = 11002;
	int iItem = Import("UTIL")->CreateItem("LS00022");

	// 新手灵兽宝宝固定为（11011），默认携带技能：铁骨（91），技囊技能：铁骨（91）、正脉（191），资质及初值为绿色品质上限的90%；
	// 千钧(5)
	// 明鉴(638)
	if ( iItem > 1 )
	{
		SetItemSave(iItem, I_SHOULONG_SUMMTYPE, iType);
		mpSkillRes = Import("SUMMON_SKILL")->GenSummonSkills(iType);	
		mpSkillRes[A_SUMM_SKILL_LIB] = ({"5", "638", });
		mpSkillRes[M_SUMM_SKILLS] = ([ "5":1, ]);
		SetItemSave(iItem, M_SHOULONG_SUMMSKILLS, mpSkillRes);

		SetItemSave(iItem, I_SHOULONG_RANDOM, 90);
	}

	return iItem;
}

void InitNewbieLingshouTalent(int summid, int iZZRate, int iIniRate)
{
	int iType = GetSummonSave(summid, I_SUMM_TYPE);
	int iGrow = GetSummonSave(summid, I_SUMM_GROW);

	int val = 0;
	// 资质
	foreach(mixed key in ({I_SUMM_ZZ_HP, I_SUMM_ZZ_MP, I_SUMM_ZZ_ATT, I_SUMM_ZZ_FANGYU, I_SUMM_ZZ_SPE, I_SUMM_ZZ_QIANGFA, I_SUMM_ZZ_KANGFA})) {
		val = (mpSummonProp[iType][key]*mpGrowInfo[iGrow]["rate"]/100)*iZZRate/100;
		SetSummonSave(summid, key, val);
	}

	// 慧根
	foreach(mixed key in ({ I_SUMM_INI_HP, I_SUMM_INI_MP, I_SUMM_INI_ATT, I_SUMM_INI_FANGYU, I_SUMM_INI_SPE, I_SUMM_INI_QIANGFA, I_SUMM_INI_KANGFA})) {
		val = mpSummonProp[iType][key]*(iIniRate)/100;
		SetSummonSave(summid, key, val);
	}
}

private int _CanUseShoulong(object oUser, int itemnum)
{
	int iType, iGrow;
	int iRealm;

	if ( oUser->IsSummonBagFull(SUMMON_BAG_NORMAL) )
	{
		oUser->TellMe("你身上放不下更多的灵兽了。");
		return 0;
	}

	// 对境界的判断...
	iType = GetItemSave(itemnum, I_SHOULONG_SUMMTYPE);
	iRealm = GetRealmByType(iType);
	if ( oUser->GetiJingjie() < iRealm )
	{
		oUser->TellMe(sprintf("您需要达到%s境界才可以与这只灵兽订下契约。", "data/jingjie_data"->GetJingjieName(iRealm)));
		return 0;
	}
	
	iGrow = GetShoulongGrow(itemnum);

	if ( !( iType && iGrow ) )
	{
		oUser->TellMe("无效兽笼，华丽丽的飘过");
		return 0;
	}

	return 1;
}	

// 协议返回，使用兽笼
void ConfirmUseShoulong(object oUser, int itemnum)
{
	int iSummon, iType, iGrow, iBagId;
	mapping mpSkillRes;

	if ( !is_item_online(itemnum) ) return ;

	if ( GetItemTemp(itemnum, I_ITEM_OWNER) != oUser->GetId() ) return ;

	iBagId = GetItemTemp(itemnum, I_ITEM_BAG);
	if ( iBagId != ITEM_BAG_NORMAL 
		&& iBagId != ITEM_BAG_TASK) return ;

	if ( oUser->FindItem(itemnum, iBagId) != GetItemTemp(itemnum, I_ITEM_POS) ) return;

	if ( !_CanUseShoulong(oUser, itemnum) ) return ;

	iType = GetItemSave(itemnum, I_SHOULONG_SUMMTYPE);
	iGrow = GetShoulongGrow(itemnum);

	iSummon = NewSummon(iType, iGrow);
	if ( iSummon <= 0 ) return ;

	mpSkillRes = GetItemSave(itemnum, M_SHOULONG_SUMMSKILLS);
	SetSummonSave(iSummon, A_SUMM_SKILL_LIB, mpSkillRes[A_SUMM_SKILL_LIB]);
	SetSummonSave(iSummon, M_SUMM_TALENTSKILLS, mpSkillRes[M_SUMM_TALENTSKILLS]);

	if (GetItemSave(itemnum, I_SHOULONG_RANDOM))
		ResetSummonTalent(iSummon, GetItemSave(itemnum, I_SHOULONG_RANDOM));	

	Import("SUMMON_SKILL")->InitSkills(iSummon, mpSkillRes[M_SUMM_SKILLS]);

	CalSummon(iSummon);

	SetSummonSave(iSummon, I_SUMM_CUR_HP, GetSummonFightValue(iSummon, I_A_HP_MAX_KEY) );
	SetSummonSave(iSummon, I_SUMM_CUR_MP, GetSummonFightValue(iSummon, I_A_MP_MAX_KEY) );

	if ( AddSummon(oUser, iSummon) < 1 ) { return ; }

	Import("COMMON_HOOK")->HatchSummon(oUser, iType);

	logger->Log("%d use shoulong %s, type %d, grow %d.",oUser->GetId(), GetItemSave(itemnum, C_GLOBAL_KEY), iType, iGrow);	
	oUser->TellMe( sprintf("您与灵兽[%s]成功订下契约", GetSummonSave(iSummon, C_SUMM_NAME)) );

	Import("ITEM_UTIL")->DecAmount(itemnum, 1);
	CheckTalentAchieve(oUser, iSummon);
}

int DoUseShoulong(object oUser, int itemnum, int iTarget)
{
	int iType;
	string cName;

	/*
	if ( iTarget )
	{
		oUser->TellMe("物品只能对自己使用");
		return 0;
	}
	*/

	if ( !_CanUseShoulong(oUser, itemnum) )
		return 0;

	cName = GetNameByType( GetItemSave(itemnum, I_SHOULONG_SUMMTYPE) );
	if ( !cName ) return 0;
	rpc_client_use_shoulong( oUser->GetId(), itemnum, sprintf("您确定与[%s]灵兽订立契约吗？", cName) );

	return 0;
}

int GetShoulongJingjie(int iItem)
{
	int iType = GetItemSave(iItem, I_SHOULONG_SUMMTYPE);
	return GetRealmByType(iType);
}

void AddLife(int summid, int iAmount)
{
	SetSummonSave( summid, I_SUMM_LIFE, GetSummonSave(summid, I_SUMM_LIFE)+iAmount ); 
}

int DoUseLifeItem(object oUser, int iItem, int iTarget, int iAdd)
{
	int uid;

	if ( !iTarget )
	{
		oUser->TellMe("此物品只能对灵兽使用");
		return 0;
	}

	if ( !is_summon_online(iTarget) ) return 0;

	uid = oUser->GetId();
	if ( GetSummonTemp(iTarget, I_T_SUMM_OWNER) != uid )
		return 0;

	/*
	if ( !Import("LOCK")->IsUnlock(oUser) )
		return 0;
	*/	

	if ( !iAdd)	return 0;

	if ( GetSummonSave(iTarget, I_SUMM_LIFE) + iAdd > GetLifeByType( GetSummonSave(iTarget, I_SUMM_TYPE) ) )
	{
		oUser->TellMe("此灵兽神完气足，不用服用此等药物");
		return 0;
	}
	logger->Log("[%d] use [%s],[%s] life add [%d] to %d.", uid, GetItemSave(iItem, C_GLOBAL_KEY), GetSummonSave(iTarget, C_GLOBAL_KEY), iAdd, iAdd + GetSummonSave(iTarget, I_SUMM_LIFE));
	AddLife(iTarget, iAdd);
	oUser->TellMe( sprintf("%s的寿命增加%d", GetSummonSave(iTarget, C_SUMM_NAME), iAdd) );
	rpc_SummonInfo(uid, iTarget);
	return 1;
}

// 对灵兽使用融合石，获取经验
int DoUseRongheStone(object oUser, int iItem, int iTarget)
{
	if(!iTarget) {
		oUser->TellMe("此物品只能对灵兽使用");
		return 0;
	}

	if(!is_summon_online(iTarget)) {
		return 0;
	}

	//int iRealm = GetSummonTemp(iTarget, I_T_SUMM_REALM); 
	int iRealm = oUser->GetiJingjie();
	int iExpAdd = 1250 * iRealm;	

	logger->Log("%d try use %s to add summon %d exp %d", oUser->GetId(), GetItemTemp(iItem, C_ITEM_NAME), iTarget, iExpAdd);
	int iRet = Import("UTIL")->AddSummonExp(oUser, iTarget, iExpAdd);
	if(iRet) {
		logger->Log("%d add summon %d exp[%d] ok", oUser->GetId(), iTarget, iRet);
		return 1;
	}
	else {
		logger->Log("%d add summon %d exp fail", oUser->GetId(), iTarget);
		return 0;
	}
}

int DoUseAddWuxingItem(object oUser, int iItem, int iTarget, int iAdd)
{
	if ( !iTarget || !is_summon_online(iTarget) )
	{
		oUser->TellMe("此物品只能对灵兽使用");
		return 0;
	}

	int uid = oUser->GetId();
	if (GetSummonTemp(iTarget, I_T_SUMM_OWNER) != uid)
		return 0;

	mapping mpInfo = GetSummonSave(iTarget, M_SUMM_QINMI_INFO);
	if ( !mpInfo || !mpInfo["points"] )
	{	
		CalQinmiWuxing(iTarget);
		mpInfo = GetSummonSave(iTarget, M_SUMM_QINMI_INFO);
	}	

	logger->Log("[%d] use [%s],[%s] wuxing add [%d] to %d.", uid, GetItemSave(iItem, C_GLOBAL_KEY), GetSummonSave(iTarget, C_GLOBAL_KEY), iAdd, iAdd + mpInfo["total"]);

	mpInfo["addon"] += iAdd;
	oUser->TellMe( sprintf("你的灵兽#R%s#n增加了#R%d#n点亲密悟性", GetSummonSave(iTarget, C_SUMM_NAME), iAdd) );
	CalQinmiWuxing(iTarget);
	rpc_SummonWuxing(uid, iTarget);
	return 1;
}


int GetRarity(int iType)
{
	return mpSummonProp[iType][SUMMON_RARITY];
}

int ChangeIcon(object oUser, int summid, int iTo)
{
	int iType = GetSummonSave(summid, I_SUMM_TYPE);
	//int iGrow = GetSummonSave(summid, I_SUMM_GROW);
	int iRarity = mpSummonProp[iType][SUMMON_RARITY];

	int iTypical = mpSummonProp[iType][SUMMON_TYPICAL];
	int iRace = mpSummonProp[iType][SUMMON_RACE];
	int iRealm = mpSummonProp[iType][I_T_SUMM_REALM];

	int iHit = 0;

	for ( int i=1; i <= iRarity; i ++ )
	{
		int _to = mpRace2Rarity[iRace][iTypical][iRealm][i];
		if ( mpSummonProp[_to][I_SUMM_RES] == iTo )
		{
			iHit = 1;
			break;
		}
	}

	if ( !iHit )
	{
		oUser->TellMe("您的灵兽还没掌握此种变化之术");
		return 0;
	}

	SetSummonSave(summid, I_SUMM_RES, iTo);     /*资源ID*/
	rpc_client_summon_iprop(oUser->GetId(), summid, "iResid", iTo);

	// 造型发生改变，需要重新设置跟随
	if (oUser->GetShowSummon() == summid) {
		oUser->HideSummon();
		oUser->SetShowSummon(summid);
	}
	return iTo;
}

int CanUpgradeIcon(object oUser, int summid, int IsChongsheng)
{
	int iType = GetSummonSave(summid, I_SUMM_TYPE);
	int iRarity = mpSummonProp[iType][SUMMON_RARITY];

	if ( iRarity == SUMMON_RARITY_GUDING
		|| iRarity == SUMMON_RARITY_LIANCHENG ) 
		return 0;

	int iRace = mpSummonProp[iType][SUMMON_RACE];
	int iGrow = GetSummonSave(summid, I_SUMM_GROW);
	int iTypical = mpSummonProp[iType][SUMMON_TYPICAL];
	int iRealm = mpSummonProp[iType][I_T_SUMM_REALM];
	int iTo = mpRace2Rarity[iRace][iTypical][iRealm][iRarity+1];

	if ( !iTo ) return 0;

	if ( ( (iRarity < SUMMON_RARITY_XIYOU) && iGrow == SUMMON_GROW_LV )
		|| (iGrow == SUMMON_GROW_LAN && (iRarity < SUMMON_RARITY_ZHENPIN) ) 
		|| (iGrow == SUMMON_GROW_ZI && (iRarity < SUMMON_RARITY_LIANCHENG) ) 
		|| (IsChongsheng && (iGrow == SUMMON_GROW_CHENG && (iRarity < SUMMON_RARITY_LIANCHENG)) )
		) 
	{
		return 1;
	}

	return 0;
}

int UpgradeIcon(object oUser, int summid)
{
	int iType = GetSummonSave(summid, I_SUMM_TYPE);
	int iGrow = GetSummonSave(summid, I_SUMM_GROW);
	int iRarity = mpSummonProp[iType][SUMMON_RARITY];

	int iTypical = mpSummonProp[iType][SUMMON_TYPICAL];
	int iRace = mpSummonProp[iType][SUMMON_RACE];
	int iRealm = mpSummonProp[iType][I_T_SUMM_REALM];

	int iTo = mpRace2Rarity[iRace][iTypical][iRealm][iRarity+1];

	if ( !iTo ) return iType;

	SetSummonSave(summid, I_SUMM_TYPE, iTo);
	SetSummonSave(summid, I_SUMM_RES, mpSummonProp[iTo][I_SUMM_RES]);     /*资源ID*/

	// 造型发生改变，需要重新设置跟随
	if (oUser->GetShowSummon() == summid) {
		oUser->HideSummon();
		oUser->SetShowSummon(summid);
	}

	//"module/rank/summon"->ChangeType(oUser, summid);
	return iTo;
}

// 反涅，回退到灵兽当前grow的上一个grow
// @param iChangeIcon 是否回退到上一个造型
// @param iTestFlg 测试标志
varargs int SummonAntiNiepan(object oUser, int summid, int iChangeIcon, int iPreType, int iTestFlg)
{
	int iType, iGrow, iRate, uid, iBakType;

	uid = oUser->GetId();
	iType = GetSummonSave(summid, I_SUMM_TYPE);
	iGrow = GetSummonSave(summid, I_SUMM_GROW);

	// 涅前的grow
	int iPreGrow = iGrow - 1;

	if(iPreGrow <= 0) return 0;

	// 资质
	foreach ( mixed key in ({I_SUMM_ZZ_HP, I_SUMM_ZZ_MP, I_SUMM_ZZ_ATT, I_SUMM_ZZ_FANGYU, I_SUMM_ZZ_SPE,I_SUMM_ZZ_QIANGFA, I_SUMM_ZZ_KANGFA}) ) 
	{
		// 前一个Grow最大值
		float _max = to_float(mpSummonProp[iType][key]*mpGrowInfo[iPreGrow]["rate"]/100);
		// 当前值
		int _to = GetSummonSave(summid, key);
		float _factor = to_float(mpSummonProp[iType][key] * to_float(mpGrowInfo[iGrow]["rate"]));
		// 前一个Grow的原值
		float _from = 100 * _to * _max / _factor;


		logger->Log(sprintf("[anti-niepan] cur_val:%O, previous Grow max:%O, _factor:%O, original_val:%O", _to, _max, _factor, _from));

		int _val = to_int(_from);
		// float转int时，舍弃了小数部分
		if(to_float(_val) < _from) ++ _val;
		if(!iTestFlg) {
			SetSummonSave(summid, key, _val);
		}

		logger->Log(sprintf("[anti-niepan] cur_val: %d", GetSummonSave(summid, key)));
	}

	logger->Log(sprintf("[anti-niepan] uid=%d summ id=%d, gblkey=%s try cal done", oUser->GetId(), summid, GetSummonSave(summid, C_GLOBAL_KEY)));

	if(!iTestFlg) {
		SetSummonSave(summid, I_SUMM_GROW, iPreGrow);
		SetSummonTemp(summid, I_T_GROW_COLOR, GetSummonColor(summid));

		string cOwner = oUser->GetName();
		string cMsg = "";

		if (iChangeIcon)
		{
			// 设置造型
			int iToType = 0;
			if(iPreType) {
				iToType = iPreType;
			}
			else {
				int iRarity = mpSummonProp[iType][SUMMON_RARITY];
				int iTypical = mpSummonProp[iType][SUMMON_TYPICAL];
				int iRace = mpSummonProp[iType][SUMMON_RACE];
				int iRealm = mpSummonProp[iType][I_T_SUMM_REALM];

				iToType = mpRace2Rarity[iRace][iTypical][iRealm][iRarity - 1];

			}
			if(iToType) {

				SetSummonSave(summid, I_SUMM_TYPE, iToType);
				SetSummonSave(summid, I_SUMM_RES, mpSummonProp[iToType][I_SUMM_RES]);     /*资源ID*/

				// 造型发生改变，需要重新设置跟随
				if (oUser->GetShowSummon() == summid) {
					oUser->HideSummon();
					oUser->SetShowSummon(summid);
				}

				//"module/rank/summon"->ChangeType(oUser, summid);
			}
		}

		rpc_client_summon_change_type(uid, summid, iType, GetSummonSave(summid, I_SUMM_TYPE), FROM_NIEPAN);

		CalSummon(summid);
		rpc_SummonInfo(uid, summid);
		rpc_SummonTalent(uid, summid);

		logger->Log("[anti-niepan] uid=%d summon %s anti-niepan, type from %d to %d, iGrow from %d to %d.", uid, GetSummonSave(summid, C_GLOBAL_KEY), iType, GetSummonSave(summid, I_SUMM_TYPE), iGrow, iPreGrow);	
	}

	return 1;
}

int SummonNiepan(object oUser, int summid)
{
	int iType, iGrow, iRate, uid, iBakType;
	//int iRarity;

	uid = oUser->GetId();
	iType = GetSummonSave(summid, I_SUMM_TYPE);
	iGrow = GetSummonSave(summid, I_SUMM_GROW);

	assert(iGrow > 0);

	if ( iGrow >= SUMMON_GROW_MAX )
	{
		oUser->TellMe("此灵兽已经不需要再涅了");
		return 0;
	}

	// 资质
	foreach ( mixed key in ({I_SUMM_ZZ_HP, I_SUMM_ZZ_MP, I_SUMM_ZZ_ATT, I_SUMM_ZZ_FANGYU, I_SUMM_ZZ_SPE,I_SUMM_ZZ_QIANGFA, I_SUMM_ZZ_KANGFA}) ) 
	{
		int _max = mpSummonProp[iType][key]*mpGrowInfo[iGrow]["rate"]/100;
		// 本身资质比例
		float _rate = to_float(GetSummonSave( summid, key)/to_float(_max));
		int _to ;

		//SetSummonSave(summid, key, GetSummonSave(summid, key)*mpGrowInfo[iGrow+1]["rate"]/mpGrowInfo[iGrow]["rate"]);
		//debug_message( sprintf("mp %d, 原始当前Grow最大值：%d. 当前值: %d", mpSummonProp[iType][key], _max, GetSummonSave( summid, key)) );
		//debug_message( sprintf("aaaa反推成长率：%f.",  _rate) );
		//debug_message( sprintf("aaaa：%O.",  _rate*mpSummonProp[iType][key]) );
		// 下一Grow最大值 
		_to = to_int(to_float(mpSummonProp[iType][key])*to_float(mpGrowInfo[iGrow+1]["rate"]));
		//debug_message( sprintf("下一grow最大值：%O.",  _to) );  
		_to = _rate*_to/100;

		SetSummonSave(summid, key, _to);

		//debug_message( sprintf("当前值: %d", GetSummonSave(summid, key)) );
	}

	// 可以封出NEXT_GROW的逻辑，不过暂时没这必要
	iGrow += 1;

	SetSummonSave(summid, I_SUMM_GROW, iGrow);
	SetSummonTemp(summid, I_T_GROW_COLOR, GetSummonColor(summid));

	//iRarity = mpSummonProp[iType][SUMMON_RARITY];
	//
	string cOwner = oUser->GetName();
	string cMsg = "";

	if ( random(100) < 10 && CanUpgradeIcon(oUser, summid, 0) )
	{
		int iTo = UpgradeIcon(oUser, summid);

		if ( iGrow == SUMMON_GROW_ZI && mpSummonProp[iTo][SUMMON_RARITY] == SUMMON_RARITY_LIANCHENG )
		{
			string cSummon = "/module/util"->GetSummonClickableName(summid);
			cMsg = sprintf("#R%s#n的灵兽#n在涅途中吸收了日月之精华，变为了#R%s#n，真是可喜可贺！#16", cOwner, cSummon);
			"cmd/chat"->SystemSay(cMsg);
		}
	}
	else
	{
		if ( iGrow == SUMMON_GROW_ZI )
		{	
			string cSummon = "/module/util"->GetSummonClickableName(summid);
			cMsg = sprintf("#R%s#n的灵兽%s成功涅为%s！#20", cOwner, cSummon, "#P珍稀灵兽#n");
			"cmd/chat"->SystemSay(cMsg);
		}
		else if ( iGrow == SUMMON_GROW_CHENG )
		{
			string cSummon = "/module/util"->GetSummonClickableName(summid);
			cMsg = sprintf("#R%s#n的灵兽%s成功涅为%s！#20", cOwner, cSummon, "#O绝世灵兽#n");
			"cmd/chat"->SystemSay(cMsg);
		}
	}	

	logger->Log("%d summon %s niepan, type from %d to %d, iGrow to %d.", uid, GetSummonSave(summid, C_GLOBAL_KEY), iType, GetSummonSave(summid, I_SUMM_TYPE), iGrow);	
	logger->DB(summon_niepan_key, GetSummonSave(summid, C_GLOBAL_KEY), iBakType, iType, iGrow);

	rpc_client_summon_change_type(uid, summid, iType, GetSummonSave(summid, I_SUMM_TYPE), FROM_NIEPAN);
	// 得到灵兽时的成就
	OnAddSummonAch(oUser, summid);

	CalSummon(summid);
	rpc_SummonInfo(uid, summid);
	rpc_SummonTalent(uid, summid);

	Import("COMMON_HOOK")->SummonNiepan(oUser);

	/*
	// 新手目标统计 精良灵兽、珍稀灵兽
	catch(SummonGrowNewbieAch(oUser, summid));
	*/

	// 新手目标统计 拥有一只蓝品质灵兽，并且缘生境界和旋照境界的技能满
	BlueSummonYuanshengXuanzhaoSkillAch(oUser, summid);

	return 1;
}


int SummonChongsheng(object oUser, int summid)
{
	int iType, iRarity, uid, iTo;

	uid = oUser->GetId();
	iType = GetSummonSave(summid, I_SUMM_TYPE);
	iRarity = mpSummonProp[iType][SUMMON_RARITY];

	if ( iRarity == SUMMON_RARITY_LIANCHENG || iRarity == SUMMON_RARITY_GUDING )
	{
		oUser->TellMe("此灵兽不能重生");
		return 0;
	}

	if ( CanUpgradeIcon(oUser, summid, 1) )
	{
		iTo = UpgradeIcon(oUser, summid);
		int _rarity = mpSummonProp[iTo][SUMMON_RARITY];

		if ( _rarity == SUMMON_RARITY_LIANCHENG )
		{
			string cMsg = sprintf("#R%s#n的灵兽成功重生至%s，#R%s#n光彩夺目，璀璨动人！#36", oUser->GetName(), "#P连城造型#n", "/module/util.c"->GetSummonClickableName(summid));
			"cmd/chat"->SystemSay(cMsg);
		}
	}

	logger->Log("%d summon %s chongsheng, type from %d to %d.", uid, GetSummonSave(summid, C_GLOBAL_KEY), iType, GetSummonSave(summid, I_SUMM_TYPE) );
	logger->DB(summon_chongsheng_key, GetSummonSave(summid, C_GLOBAL_KEY), iType, GetSummonSave(summid, I_SUMM_TYPE) );

	rpc_client_summon_change_type(uid, summid, iType, GetSummonSave(summid, I_SUMM_TYPE), FROM_CHONGSHENG);
	CalSummon(summid);
	// 得到灵兽时的成就
	OnAddSummonAch(oUser, summid);

	rpc_SummonInfo(uid, summid);

	return 1;
}


private void ModiRarityTbl(int _type, int _rarity, int _race, int _typical, int _realm)
{
	if ( undefinedp(mpRace2Rarity[_race]) )
		mpRace2Rarity[_race] = ([]);
	if ( undefinedp( mpRace2Rarity[_race][_typical] ) )
		mpRace2Rarity[_race][_typical] = ([]);

	if ( undefinedp( mpRace2Rarity[_race][_typical][_realm]) )
		mpRace2Rarity[_race][_typical][_realm] = ([]);
	mpRace2Rarity[_race][_typical][_realm][_rarity] = _type;
}

/*
void selflog(string c)
{
	log_file("summon_selftest", c + "\n");
}	

void SelfTest()
{
	for ( int i=1; i<= 60; i ++)
	{
		if ( mpGradeInfo[i] != mpAttribInfo[i]["grade"] )
			selflog( sprintf("[summon info error] %d grade", i) );

		if ( mpSpeedInfo[i] != mpAttribInfo[i]["speed"] )
			selflog( sprintf("[summon info error] %d speed", i) );
	}

	selflog( sprintf("all done") );
}
*/

void ReloadAttrib()
{
	mpAttribInfo = "data/summon_attrib"->get_data();
}	

void create()
{
	int iPutongType;

	ReloadAttrib();

	//SelfTest();

	create_logger();

	// 自动生成
	foreach ( int iType, mapping mpInfo in mpSummonProp )
	{
		int _realm = mpInfo[I_T_SUMM_REALM];

		if ( undefinedp( mpAllRealms[_realm]) )
			mpAllRealms[_realm] = ({});

		// 境界表
		mpAllRealms[_realm] += ({iType});

		// 以下是稀有度表
		if ( mpInfo[SUMMON_RARITY] == SUMMON_RARITY_PUTONG )
		{
			iPutongType = iType;
		}
		else
		{	
			iPutongType = 0;
			foreach ( int _iType, mapping _mpInfo in mpSummonProp )
			{
				if ( mpInfo[SUMMON_RACE] == _mpInfo[SUMMON_RACE]
				 && mpInfo[SUMMON_TYPICAL] == _mpInfo[SUMMON_TYPICAL]
				 && _mpInfo[SUMMON_RARITY] == 1 ) // 最普通的造型	 
				{
					iPutongType = _iType;
					break;
				}	
			}

			assert( iPutongType );
		}

		if ( undefinedp(mpBaseRarity[iPutongType]) )
			mpBaseRarity[iPutongType] = ([]);

		mpBaseRarity[iPutongType][mpInfo[SUMMON_RARITY]] = iType;
		ModiRarityTbl( iType, mpInfo[SUMMON_RARITY], mpInfo[SUMMON_RACE], mpInfo[SUMMON_TYPICAL], _realm );
	}
}

mapping GetAllSummonByGM(object oUser)
{
	mapping mpRes = ([]);

	foreach ( int iBagId in SUMMON_BAGS)
	{
		mpRes[iBagId] = ([]);
		for( int iPos =1; iPos<= oUser->GetSummonBagSize(iBagId); iPos ++)	
		{
			int _summonid = oUser->GetSummonByPos(iBagId, iPos);

			if ( _summonid > 0 )
			{
				mapping _mpTmp = ([]);

				_mpTmp[PERM_VAR] = get_summon_map(_summonid, PERM_VAR);
				_mpTmp[TEMP_VAR] = get_summon_map(_summonid, TEMP_VAR);

				mpRes[iBagId][iPos] = _mpTmp;
				//oUser->TellMe( sprintf("iPos %d, _summonid = %O", iPos, mpRes[iBagId][iPos]) );
			}
		}	
	}

	return mpRes;
}	


static mapping mpSummColor = ([
		1 : 0xFF00ff00,
	    2 : 0xFF0077ff,
		3 : 0xFFE066FF,
		4 : 0xFFDC6400,
		]);

int GetSummonColor(int summonid)
{
	int iGrow = GetSummonSave(summonid, I_SUMM_GROW);
	return mpSummColor[iGrow];
}

void SetNewbieFachong(int summid)
{
	ResetSummonTalent(summid, 90);

	SetSummonSave(summid, A_SUMM_SKILL_LIB, ({"345", "39", }) ); 
	Import("SUMMON_SKILL")->InitSkills(summid, (["39":1,]));

	CalSummon(summid);
}

void SetNewbieGongchong(int summid)
{
	ResetSummonTalent(summid, 90);

	SetSummonSave(summid, A_SUMM_SKILL_LIB, ({"5", "638", }) ); 
	Import("SUMMON_SKILL")->InitSkills(summid, (["5":1,]));

	CalSummon(summid);
}	

mixed *GetSummonSkillLib(int summid)
{
	return GetSummonSave(summid, A_SUMM_SKILL_LIB);
}


int NewbieSummon(int iGrade)
{
	if ( iGrade == 10 )
	{
		int iSummon = NewSummon(21011, 1);
		SetNewbieFachong(iSummon);

		return iSummon;
	}
}

int NewbieYiyi()
{
	int iSummon = NewSummon(22000, 1);
	SetNewbieFachong(iSummon);

	return iSummon;
}

int NewbieQiqi()
{
	int iSummon = NewSummon(11000, 1);
	SetNewbieGongchong(iSummon);

	return iSummon;
}

int NewbieXiaoHuli()
{
	int iSummon = NewSummon(22011, 1);
	SetNewbieFachong(iSummon);

	return iSummon;
}

// 使用缘生果
void UseYuanSheng( object oUser, int itemid, int iTarget) 
{
	mapping options;
	int iOwner;

	if (iTarget == 0)
	{
		oUser->TellMe( "缘生果只能对普通灵兽使用" );
		return ;
	}
	
	iOwner = GetSummonTemp(iTarget, I_T_SUMM_OWNER);

	if (iOwner != oUser->GetId() )
	{
		oUser->TellMe( "缘生果只能对自己的灵兽使用" );
		return ;
	}

	// 判断解锁
	if ( !Import("LOCK")->IsUnlock(oUser) ) return ;

	"cmd/confirm_dialog"->SendConfirmDialog(oUser->GetId(), "使用确认", 
"#R" + GetSummonSave( iTarget, C_SUMM_NAME) + "#n将会变回1级，仅保留技囊技能，你确定吗？", 
		"确定", "取消", "DoUseYuanSheng", ({ itemid, iTarget, }) );
}

// 使用缘生果
int DoUseYuanSheng( object oUser, int result, int itemid, int iTarget) 
{
	int iOwner;
	mapping mpSkillGrid;
	mapping mpSkills;

	if ( result != 1) { return 0; }	

	// 判断解锁
	if ( !Import("LOCK")->IsUnlock(oUser) ) return 0;

	if (iTarget == 0)
	{
		oUser->TellMe( "缘生果只能对普通灵兽使用" );
		return 0;
	}
	
	iOwner = GetSummonTemp(iTarget, I_T_SUMM_OWNER);
	if (iOwner != oUser->GetId() )
	{
		oUser->TellMe( "缘生果只能对自己的灵兽使用" );
		return 0;
	}

	if ( GetSummonSave(iTarget, I_SUMM_GRADE) <= 1 )
	{
		oUser->TellMe( "此灵兽尚且幼稚，无法使用缘生果" );
		return 0;
	}

	if ( GetSummonSave(iTarget, I_SUMM_GROW) > 1 )
	{
		oUser->TellMe( "您的灵兽资质非凡，拒绝使用缘生果" );
		return 0;
	}	

	if (GetItemTemp(itemid, I_ITEM_OWNER) != oUser->GetId()) return 0;

	logger->Log("%d use 缘生果", iOwner);
	Import("ITEM_UTIL")->DecAmount(itemid, 1);

	// 设置灵兽等级
	SetSummonSave(iTarget, I_SUMM_GRADE, 1);
	SetSummonSave(iTarget, I_SUMM_EXP, 0);
	// 清空所有技能
	Import("SUMMON_SKILL")->InitSkills( iTarget, ([]) );
	
	// 服用缘生果将清空灵兽所带临时buff；

	// 重新计算灵兽属性
    CalSummon(iTarget);
	// 同步
    rpc_SummonInfo(oUser->GetId(), iTarget);
	rpc_SummonSkill(oUser->GetId(), iTarget);

	oUser->TellMe("#R" + GetSummonSave(iTarget, C_SUMM_NAME) +"#n成功服用缘生果，变回灵兽宝宝");
}

// 取得兽笼的造型
varargs string ShoulongTypeByGrow(int iRealm, int iGrow, int iRace, int iType)
{
	return "module/summon/shoulong_info"->GetShoulong(iRealm, iGrow, iRace, iType);
}


string Race2String( int race )
{
	return mpRaceInfo[race];
}

int FightingPoint(int summid)
{
	int iType = GetSummonSave(summid, I_SUMM_TYPE);
	int iTotal = 0;
	int index = 0;
	mixed * AllKeys = ({I_SUMM_ZZ_HP, I_SUMM_ZZ_MP, I_SUMM_ZZ_ATT, I_SUMM_ZZ_FANGYU, I_SUMM_ZZ_SPE,
			I_SUMM_ZZ_QIANGFA, I_SUMM_ZZ_KANGFA,	
			I_SUMM_INI_HP, I_SUMM_INI_MP, I_SUMM_INI_ATT, I_SUMM_INI_FANGYU, I_SUMM_INI_SPE,
			I_SUMM_INI_QIANGFA, I_SUMM_INI_KANGFA, });

	mapping mpRarityPoint = ([
			SUMMON_RARITY_PUTONG : 0,
			SUMMON_RARITY_XIYOU : 100,
			SUMMON_RARITY_ZHENPIN : 200,
			SUMMON_RARITY_LIANCHENG : 400,
			SUMMON_RARITY_GUDING : 0,
			]);

	float * Arr = allocate(sizeof(AllKeys));

	foreach ( mixed key in AllKeys ) // 资质 慧根 强法抗法
	{
		Arr[index] = to_float(GetSummonSave(summid, key))/to_float(mpSummonProp[iType][key]);
		//debug_message( sprintf("%O/%O", to_float(GetSummonSave(summid, key)), to_float(mpSummonProp[iType][key])) );
		index ++;
	}

	Arr = sort_array(Arr, -1);

	for( int i=0; i <8; i ++)
	{
		//debug_message( sprintf("%d=%O", i, Arr[i]) );
		iTotal += 100*( pow(Arr[i], 2) );
	}

	mapping mpGrowPoint = ([
			SUMMON_GROW_LV : 0,
			SUMMON_GROW_LAN : 300,
			SUMMON_GROW_ZI : 600,
			SUMMON_GROW_CHENG : 1200,
			]);

	iTotal += mpGrowPoint[ GetSummonSave(summid, I_SUMM_GROW) ];

	string * SkillLibs = GetSummonSave(summid, A_SUMM_SKILL_LIB);	
	mapping mpSkillRealm = ([]);

	foreach( string skillid in SkillLibs )
	{
		int iRealm = Import("SUMMON_SKILL")->SkillRealm(skillid);
		if ( iRealm < 1 )
		{	
			debug_message( sprintf("ERROR! skillid %O has no realm.", skillid) );
			continue;
		}	
		mpSkillRealm[iRealm] += 1;
	}

	int iRace = mpSummonProp[iType][SUMMON_RACE];

	foreach( int _realm, int _amount in mpSkillRealm)
	{
		iTotal += pow( to_float(_amount)/Import("SUMMON_SKILL")->RealmSkillLibAmount(iRace, _realm), 2) * _realm * 300;

		//debug_message( sprintf("%d/%d, iTotal %d", _amount, Import("SUMMON_SKILL")->RealmSkillLibAmount(iRace, _realm), iTotal ) );
	}

	iTotal += mpRarityPoint[ GetRarity(iType) ];

	iTotal = to_int(iTotal);

	SetSummonTemp(summid, I_T_SUMM_FIGHTPOINT, iTotal);

	return iTotal;
}

int GetSummonIdByGblKey(object oUser, string cGblKey)
{
	mapping mpGblKeys = oUser->GetTemp(M_T_SUMMON_GLOBAL_ID); if(undefinedp(mpGblKeys[cGblKey])) return 0;
	return mpGblKeys[cGblKey];
}

#endif
