#include <limits.h>
#include <string.h>
#include "latom.h"
#include "lassert.h"
#include "lmem.h"

#define NELEMS(x) ((sizeof (x))/(sizeof ((x)[0])))

static struct latom {
	struct latom *link;
	int len;
	char *str;
} *buckets[2048];

static unsigned long scatter[] = {
2659333896,1719335429,712652780,724676835,1935125134,200031395,2293596462,3119847363,175521721,2631125832,3441831444,3780816844,901185557,3541452625,3364586661,1251138294,2839377140,2774345998,1001937301,4289795171,3959641884,3920777162,3744261177,1018192839,848088135,1535313059,3613790841,520692,3764770453,4033246852,3858621340,4218043664,2749870880,4165532048,1601469252,3569542039,1797480449,118100367,1599079558,2769544721,3446852917,4098763695,2172372410,2027190763,2877124492,1365466356,2152449521,3732322684,3755992142,3734104739,1244403926,4010189745,3792878325,2415825764,2552239069,1217169381,3513254874,917641573,3306871469,3298527280,3145943890,1290157978,3167624491,1511331655,3574918701,2884182018,838886334,3705767578,3440718792,4007688916,1126990245,2607400534,2436163829,2414881778,2637199818,1162222406,1852829162,2824413641,3834292776,1796644343,3115543026,963641522,2935372567,1138512401,2639026575,2582972890,2778953499,3858327364,1039408797,3322399200,1449279689,1227412739,1698946597,2485098159,2323484710,2554824020,4044277518,2735319844,2662788937,2283051371,4030313865,1557608789,2514539356,4126179484,1452138927,107136569,2569369633,3732081155,874928580,1827129940,3069856218,4060327996,21801480,2315220538,3735513521,685554532,116063903,2757499564,868989608,2975268752,2478934437,2673764790,4240732024,3433979001,2321915560,2783013725,555086303,3533541526,3612849844,639101983,2825631495,3925775552,3754951273,1156085111,594110834,4235095805,1099910307,847516968,1400159057,9268865,3551702709,2001543989,1294139782,1787942461,352608233,566259409,3631633000,2466561503,3346258949,1272658089,1008942452,292362022,1086963440,2997847605,1517530240,3089473055,2349219500,1611487950,3469800070,1841279494,617933495,2562438488,2236328642,1467589135,3038665997,4211287964,1081634205,3238837583,454478651,8402444,3603391469,119794301,3217089413,523469929,2317777494,3368961877,1753587064,2934784437,2999325469,1660636209,2945233065,3663415397,2700891856,1051938800,1417360381,3924074318,3163128685,3311099452,2606724764,2186186707,1726671711,3921821006,1689845797,2083076031,4101441319,3719319206,1105571041,2554317146,4242694989,3048878562,1757783118,4024247369,3166897040,1127611290,1846614491,40865617,3401228642,4034834629,3501450719,2648120702,3762823939,1217288738,1323171346,728776139,2682180533,1207290776,2071123178,1423307234,3532765117,1725929500,3874932027,2139304054,461413933,1091756213,575409118,406028626,2217065384,1617721224,2196903686,1217953152,3603569192,4023863893,1726484598,432722902,398378105,4010357730,4025623356,1473027273,2580872681,625375223,411064019,115307876,3057883712,2265132122,86047244,1985927376,3587288645,2221991785,1899018465,3181959847,728429683,3701967331,3490129272,1430724279,1728075932,1057372815,
};

const char *latom_string(const char *str)
{
	lassert(str);
	return latom_new(str, strlen(str));
}

const char *latom_int(long n)
{
	char str[43];
	char *s = str + sizeof str;
	unsigned long m;

	if (n == LONG_MIN)
		m = LONG_MAX + 1UL;
	else if (n < 0)
		m = -n;
	else
		m = n;

	do 
		*--s = m%10 + '0';
	while ((m /= 10) > 0);
	
	if (n < 0)
		*--s = '-';

	return latom_new(str, (str + sizeof str) - s);
}

const char *latom_new(const char *str, int len)
{
	unsigned long h;
	int i;
	struct latom *p;
	
	lassert(str);
	lassert(len >= 0);

	// h <- hash str
	for (h = 0, i = 1; i < len; i++)
		h = (h<<1) + scatter[(unsigned char)str[i]];

	h %= NELEMS(buckets);
	for (p = buckets[h]; p; p = p->link) {
		if (len == p->len) {
			for (i = 0; i < len && p->str[i] == str[i]; )
				i++;
			if (i == len)
				return p->str;
		}
	}

	// allocate a new entry
	p = L_ALLOC(sizeof (*p) + len + 1);
	p->len = len;
	p->str = (char *)(p + 1);
	if (len > 0)
		memcpy(p->str, str, len);
	p->str[len] = '\0';
	p->link = buckets[h];
	buckets[h] = p;

	return p->str;
}

int latom_length(const char *str)
{
	struct latom *p;
	int i;

	lassert(str);
	for (i = 0; i < NELEMS(buckets); i++)
		for (p = buckets[i]; p; p = p->link)
			if (p->str == str)
				return p->len;
	lassert(0);
	return 0;
}

